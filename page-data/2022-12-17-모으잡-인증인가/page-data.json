{"componentChunkName":"component---src-templates-post-jsx","path":"/2022-12-17-모으잡-인증인가/","result":{"data":{"site":{"siteMetadata":{"title":"Troy DevLog"}},"markdownRemark":{"id":"bc74e94c-1d4a-5507-a390-a54e07d094e6","excerpt":"🔓 SSR을 이용한 인증/인가 도입 이번에 프로젝트를 고민하면서 항상 답답했던 부분이었던 페이지 redirection과 인증 과정에 대해 더 깊이 공부했다. CSR로 처리하던 인증 방식을 SSR로 수정하기까지 과정을 정리해 보려 한다. 😅 Firebase의 API를 이용한 User 상태 관리 기존 Authentication은 firebase Auth를 이…","html":"<h1>🔓 SSR을 이용한 인증/인가 도입</h1>\n<p>이번에 프로젝트를 고민하면서 항상 답답했던 부분이었던 페이지 redirection과 인증 과정에 대해 더 깊이 공부했다. CSR로 처리하던 인증 방식을 SSR로 수정하기까지 과정을 정리해 보려 한다.</p>\n<h2>😅 Firebase의 API를 이용한 User 상태 관리</h2>\n<p>기존 Authentication은 firebase Auth를 이용해 받아온 user정보의 <strong>token을 localstorage에 저장</strong>해서 확인했다. localstorage에 token을 저장하는 방식은 보안에 취약하다는 얘기를 많이 들어, 새로운 방법을 고민하고 있었다. 고민과정에서 firebase의 API로 <code class=\"language-text\">onAuthStateChanged</code>가 있다는 것을 알게 되었고, API를 이용한다면 별도의 토큰과 쿠키를 직접 저장하지 않아도 될 것이란 예상이 되어 적용했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">//AuthService.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthServiceImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\n  googleProvider<span class=\"token operator\">:</span> GoogleAuthProvider<span class=\"token punctuation\">;</span>\n  githubProvider<span class=\"token operator\">:</span> GithubAuthProvider<span class=\"token punctuation\">;</span>\n  auth<span class=\"token operator\">:</span> Auth<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> app<span class=\"token operator\">:</span> FirebaseApp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>googleProvider <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GoogleAuthProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>githubProvider <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GithubAuthProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>auth <span class=\"token operator\">=</span> <span class=\"token function\">getAuth</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token function\">onUserStateChanged</span><span class=\"token punctuation\">(</span>callback<span class=\"token operator\">:</span> Dispatch<span class=\"token operator\">&lt;</span>SetStateAction<span class=\"token operator\">&lt;</span>User <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">>></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">onAuthStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//AuthContext.tsx</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">InitialValue</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  authService<span class=\"token operator\">:</span> AuthService<span class=\"token punctuation\">;</span>\n  user<span class=\"token operator\">:</span> User <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> AuthContext <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">createContext</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>InitialValue <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">AuthProvider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> children<span class=\"token punctuation\">,</span> authService <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> AuthProviderProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>user<span class=\"token punctuation\">,</span> setUser<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>User <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    authService<span class=\"token punctuation\">.</span><span class=\"token function\">onUserStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AuthContext.Provider</span></span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> user<span class=\"token punctuation\">,</span> authService <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AuthContext.Provider</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useAuthService</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token function\">useContext</span><span class=\"token punctuation\">(</span>AuthContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Not under AuthProvider'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>이렇게 수정하고 API를 이용해 login상태를 확인해서 페이지 이동을 하다 보니 다른 문제가 생겼다. 랜더링을 하고 API로 user상태를 바꾸기 전, 초기 값이 null로 되어있어 API 호출시 <strong>user가 없는 상태로 호출</strong>되어 에러가 나타났다. 우선 useJobs 훅 내부에 useEffect로 user상태가 달라지면 refetch해 받아올 수 있게 해결했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useSpecificJobs</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> user <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAuthService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> query<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> dbService <span class=\"token operator\">=</span> <span class=\"token function\">useDBService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> getFilteredJobs <span class=\"token operator\">=</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span><span class=\"token constant\">JOBS_KEY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> dbService<span class=\"token punctuation\">.</span><span class=\"token function\">getJobs</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">select</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token operator\">:</span> ModifiedJobsType<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> item<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    getFilteredJobs<span class=\"token punctuation\">.</span><span class=\"token function\">refetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>user<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>채용공고들을 받아오는 과정이 늘어나게 되어 <strong>같은 API를 두번 호출하는 과정에서 시간이 더 오래 걸리게 되었다</strong>.</p>\n<p>[호출 과정]</p>\n<ol>\n<li>메인 페이지 렌더링</li>\n<li>API호출</li>\n<li>User상태 업데이트</li>\n<li>API 재호출</li>\n</ol>\n<p>해결방법으로 user를 먼저 받고 API콜을 하는 방법과, auth를 server-side로 먼저 받아오는 방법 두가지 방법이 떠올랐다. 그중 먼저 현재 진행하고 있는 CSR에서 해결방법을 찾아보았다.</p>\n<h2>💻 CSR에서의 해결법: Protected Route 도입</h2>\n<p>CSR에서 해결하기 위해서는 fetch로 user를 받아온 후에 api를 호출할 수 있게 해야 했다. 검색해서 새롭게 알게 된 것은 Protected Route라는 HOC를 이용하는 방법이었다.</p>\n<h3>1) 로그인 flow 수정하기</h3>\n<p>먼저 가장 시급한 문제는 로그인 후에 메인 페이지 이동시에 User가 없는 상태로 API가 호출된다는 점이었다. 이것을 막기 위해서는 먼저 user상태를 관리해 줄 수 있는 component가 필요했고, AuthStateChanged라는 컴포넌트를 만들어 컴포넌트가 마운트되면 먼저 User를 받아오고, 이후에 메인 페이지가 렌더링 될 수 있게 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// AuthStateChanged.tsx</span>\n\n<span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useEffect<span class=\"token punctuation\">,</span> useState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useAuthService <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../context/AuthContext'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">AuthStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  children<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  children<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span>ReactNode<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> authService<span class=\"token punctuation\">,</span> setUser <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useAuthService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>loading<span class=\"token punctuation\">,</span> setLoading<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    authService<span class=\"token punctuation\">.</span><span class=\"token function\">onUserStateChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setLoading</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loading<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">로딩중</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">;\n  }\n\n  return </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">;\n}\n\n// _app.tsx\n\nfunction MyApp(</span><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps <span class=\"token punctuation\">}</span><span class=\"token plain-text\">: AppProps) </span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">QueryClientProvider</span></span> <span class=\"token attr-name\">client</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>queryClient<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DBProvider</span></span> <span class=\"token attr-name\">dbService</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>dbService<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AuthProvider</span></span> <span class=\"token attr-name\">authService</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>authService<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AuthStateChanged</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n              </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span> <span class=\"token attr-name\">theme</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>theme<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">GlobalStyle</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n                </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Component</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>pageProps<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n              </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AuthStateChanged</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AuthProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DBProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">QueryClientProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\nexport default MyApp;</span></code></pre></div>\n<p>User가 있어야만 다음 컴포넌트들로 넘어가 동작하기 때문에 이전 가장 큰 문제였던 API를 정상적으로 한번만 호출하게 해결할 수 있었다.</p>\n<p>하지만 여전히 살짝 문제가 남아있었던 것은 AuthStateChanged에서 User를 받아오는 동안 <strong>화면에 로딩을 보여줘야 한다</strong>는 점이었다. 로딩을 안 보여주기 위해 loading이 true일 때 <code class=\"language-text\">&lt;>&lt;/></code> 리액트 fragment로 반환한다 해도 여전히 불러오는 동안의 빈 페이지가 보였다.</p>\n<p>[AuthStateChanged 컴포넌트를 추가한 후 새로고침한 모습]</p>\n<p><img src=\"/static/%EC%83%88%EB%A1%9C%EA%B3%A0%EC%B9%A8-6af282af41ee41149f0df9f1fef67202.gif\" alt=\"새로고침\"></p>\n<h3>2) Protected Route</h3>\n<p>두 번째로 로그인하지 않고 메인 페이지에 접속하는 경우와 로그인 후에도 로그인 페이지에 접속하려는 경우를 막기 위한 리다이렉션 로직이 필요했다. 이것을 위해서 AuthStateChanged 컴포넌트와 유사하게 조건에 따라 렌더링을 해줄 수 있는 ProtectedRoutes 컴포넌트를 추가했다. Protected Route는 필요한 페이지에 맞게 사용되어야 했기 때문에 type을 정할 때 Generic을 이용해 정해 줄 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">//ProtectRoute.tsx</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useRouter <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"next/router\"</span>\n<span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> ComponentType <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useAuthService <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../context/AuthContext\"</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">withPublic</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>Component<span class=\"token operator\">:</span> ComponentType<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">WithPublic</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> <span class=\"token function\">useAuthService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">useRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Component</span></span> <span class=\"token attr-name\">auth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>auth<span class=\"token punctuation\">}</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">withProtected</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>Component<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span>ComponentType<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">WithProtected</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> <span class=\"token function\">useAuthService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">useRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>auth<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Component</span></span> <span class=\"token attr-name\">auth</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>auth<span class=\"token punctuation\">}</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// pages/login.tsx</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Login</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">withPublic</span><span class=\"token punctuation\">(</span>Login<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Pages/register.tsx</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">withPublic</span><span class=\"token punctuation\">(</span>Register<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// pages/index.tsx</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">withProtected</span><span class=\"token punctuation\">(</span>Home<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// pages/job/[id].tsx</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">withProtected</span><span class=\"token punctuation\">(</span>Index<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Protected Route를 이용해 로그인을 한 후에 home에서 login으로 이동하거나 로그인을 하지 않고 login에서 home으로의 이동을 막을 수 있었다. 하지만 여전히 앞서 문제가 되었던 페이지 이동시간동안 <strong>로딩을 보여줘야 하는 문제</strong>가 있었다.</p>\n<p>Protected Routes를 알기 전에 해결방법으로 떠올렸던 <strong>서버사이드에서 auth를 미리 받아와</strong> 렌더링 전에 체크한 후에, 해당 페이지에서 auth를 바로 받아볼 수 있다면 좀 더 로직도 간단해지고, next를 잘 활용하는 방법이 되지 않을까라는 생각이 들어 다시 찾아보기 시작했다.</p>\n<h2>💾 Next-auth를 이용한 SSR로 전환</h2>\n<p>SSR을 이용하기 위한 방법을 찾기위해 Next JS 공식 사이트를 찾아보니, 제시된 방법으로 <code class=\"language-text\">with-iron-session</code>과 <code class=\"language-text\">next-auth</code>라는 라이브러리를 이용하는 방법이었다. 그중에서 기존 지원했던 OAuth를 이용한 로그인 방식을 그대로 사용할 수 있는 <strong>next-auth</strong>를 선택했다.</p>\n<p>[next auth]\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/07dfc7a7fbbdf936a0f78809274688e7/c7953/next-auth.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABzElEQVR42mVSy27UMBTtl/EvLPiE7hASf8BjVSHUiqK2Gx4Si4GKlkpFIBU0U1SxAMpMmZapZkjiOLETv+LDjZNMGGHp+trHx8dH93ot4xxFIZFEKc7PZuAsg6S9lBLee6Cq4JWBrzxo12C00sbi63iO39cLSCGRcgEhS6zRKazzeLpxio07Axxsf6qhcBmVw/nJEO+eH2E8mvQ4za+/RXgySvHh0sK4KqAVPR4EF5HBjVt7uL19iJ2Hp1C8DAQIjoPNXazffYzB1j68cQHWTmMwneHtdYEHxzMsMh1wa10jWI/7m19wc/0zRkeLxoNv3MyPP+Lk3g5+vD9b4vXJhYjwaPgdz4ZXnQTKsuwFDdUpuZp3N9pakclcYPJzDKXUCl6qEpPpJbTW/wtaa5FLgUzm1KCCSuewxPOcCs4hhIBrcWMNcpEjzzLKIvA6fhCsOxrHMZIkCbl7tRb/E8WIE4aIzjpcawNGe8ZY4BtjVptSW03TFJxeZJSXBGegMwZFYcm9rxqHSrV8ngYTXTmWgqvDt1+Duq893iQO+3UwB259z/C+57frIGhocvRp67/UhabwhF/kDi9+GbyaGrykPC9cuKT/4Rrbh9IWfwHckvleUnmoJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='next auth' title='' src='/static/07dfc7a7fbbdf936a0f78809274688e7/ca1dc/next-auth.png' srcset='/static/07dfc7a7fbbdf936a0f78809274688e7/e7570/next-auth.png 170w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/f46e7/next-auth.png 340w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/ca1dc/next-auth.png 680w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/02d09/next-auth.png 1020w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/9d567/next-auth.png 1360w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/c7953/next-auth.png 1896w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>next auth</figcaption>\n  </figure></p>\n<p>Next-auth는 Next js에서 쉽게 인증과정을 구현해 줄 수 있는 라이브러리로, API Routes를 이용해 서버단에서 session과 토큰을 만들고 확인해 client에서 필요했던 확인로직을 줄여줄 수 있다. Next Auth를 공부하면서 굉장히 다양한 Provider들을 OAuth로 제공해준다는 점이 놀라웠다. 특히, 카카오톡과 네이버도 지원해준다는 점이 신기했고, 다양한 DB와도 연동해서 사용할 수 있어 좋았다.</p>\n<p>SSR을 Next-auth로 적용할 수 있다는 사실을 알게 된 후에, 라이브러리를 잘 사용하기 위해 <strong>인증, 인가 과정</strong>과 앞서 사용했던 방식인 <strong>local storage에 두는 방식이 왜 안 좋은지</strong>에 대해 이해하고, <strong>Next-auth가 해결책이 될 수 있는지</strong> 고민했다.</p>\n<h3>😖 토큰을 localStorage에 두면 안되는 이유</h3>\n<p>local storage는 브라우저가 닫혀도 유지되기 때문에 로그인을 유지할 수 있는 간편한 방법으로 사용해왔다. 하지만 이러한 방식은 <code class=\"language-text\">XSS (Cross-Site Scripting) 공격</code>에 취약한 단점을 가진다.</p>\n<h4>XSS (Cross-site scripting)</h4>\n<p>XSS 공격은 웹사이트에 <strong>악성 스크립트를 주입하는 방식</strong>으로 주로 페이지의 input이나 form을 이용해 공격하는 방식이다. 주입해놓은 사이트에 사용자가 로그인하게 될 경우에 사용자의 토큰, 쿠키 등의 정보를 빼낼 수 있게 된다. 그렇기 때문에 자바스크립트로 접근할 수 있는 localstorage나 별도의 옵션이 없는 쿠키에 토큰을 저장하게 될 경우에는 XSS 공격에 취약하게 된다.</p>\n<img src='https://cdn.inflearn.com/public/files/courses/327087/fbade0da-7961-4789-b25b-106f68ba9abb/blob' width='800'>\n<p>이것을 막기 위해서는 <code class=\"language-text\">in-memory에 저장하는 방식</code>과 <code class=\"language-text\">http only 쿠키</code>를 이용하는 방식이 있다. in-memory에 저장할 경우에는 관리는 쉽지만 로그인을 유지할 수가 없는 단점이 있어, 보통 http only 쿠키로 서버에서 토큰을 보내주면 브라우저에 저장하고 자동으로 요청시 담아서 보내는 방식을 적용할 수 있다. 하지만 http only 쿠키로 토큰을 저장하는 방법도 <code class=\"language-text\">CSRF 공격</code>에 약한 단점이 존재한다.</p>\n<h4>CSRF(Cross-site Request Forgery)</h4>\n<p>CSRF공격은 사용자가 원하지 않은 action을 하게하는 해킹 방법으로, 로그인한 사용자의 정보를 이용해 사용자 몰래 브라우저에 저장되어있는 쿠키를 이용해 요청을 보내는 방식이다. http only로 된 쿠키이기 때문에 해킹범이 쿠키를 직접 빼올 수는 없지만, 대신 자신이 원하는 요청에 사용자의 토큰을 이용해 사용할 수 있다. 그렇기 http only 쿠키만 사용하는 것이 아니라 추가적인 인증방식이 필요한데, 이때 사용할 수 있는 방법이 <code class=\"language-text\">CSRF 토큰</code>이다.</p>\n<img src='https://velog.velcdn.com/images%2Fgwanuuoo%2Fpost%2F7f926efe-4b52-49d9-8dfd-78b26c0c1bb1%2FScreen%20Shot%202021-06-27%20at%202.15.28%20PM.png' width='500'>\n<p>CSRF 토큰은 서버에서 발급하는 인증용 토큰으로, 클라이언트는 받은 토큰을 in-memory에 저장해 두고 이후 요청에 토큰을 함께 보낸다. 만약에 해킹범이 CSRF공격을 한 후에 사용자의 쿠키를 이용해 요청을 보내더라도, 사용자가 직접보내는 것이 아니라면 토큰이 없기 때문에 서버가 확인할 수 있게해 공격을 막을 수 있다.</p>\n<img src='https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F993D89425DFDDDD614' width='500'>\n<p>그러면 Next-auth를 이용한 인증방식은 어떻게 이루어지고 있을까?</p>\n<h3>Next-auth의 보안 방식과 적용</h3>\n<p>Next-auth는 OAuth와 JWT를 지원하고, 무엇보다 고민했던 보안 문제를 한번에 해결해 줄 수 있었다. <code class=\"language-text\">CSRF토큰</code>을 POST 요청에 적용하고, 인증을 위한 토큰과 세션들을 <code class=\"language-text\">server-readable-only cookie</code>로 자동으로 관리해준다. 두가지 덕분에 앞서 알아보았던 XSS공격과 CSRF 공격을 방어하면서 인증을 편하게 할 수 있다는 것을 확인했다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/07dfc7a7fbbdf936a0f78809274688e7/c7953/next-auth.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 47.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABzElEQVR42mVSy27UMBTtl/EvLPiE7hASf8BjVSHUiqK2Gx4Si4GKlkpFIBU0U1SxAMpMmZapZkjiOLETv+LDjZNMGGHp+trHx8dH93ot4xxFIZFEKc7PZuAsg6S9lBLee6Cq4JWBrzxo12C00sbi63iO39cLSCGRcgEhS6zRKazzeLpxio07Axxsf6qhcBmVw/nJEO+eH2E8mvQ4za+/RXgySvHh0sK4KqAVPR4EF5HBjVt7uL19iJ2Hp1C8DAQIjoPNXazffYzB1j68cQHWTmMwneHtdYEHxzMsMh1wa10jWI/7m19wc/0zRkeLxoNv3MyPP+Lk3g5+vD9b4vXJhYjwaPgdz4ZXnQTKsuwFDdUpuZp3N9pakclcYPJzDKXUCl6qEpPpJbTW/wtaa5FLgUzm1KCCSuewxPOcCs4hhIBrcWMNcpEjzzLKIvA6fhCsOxrHMZIkCbl7tRb/E8WIE4aIzjpcawNGe8ZY4BtjVptSW03TFJxeZJSXBGegMwZFYcm9rxqHSrV8ngYTXTmWgqvDt1+Duq893iQO+3UwB259z/C+57frIGhocvRp67/UhabwhF/kDi9+GbyaGrykPC9cuKT/4Rrbh9IWfwHckvleUnmoJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='next-auth' title='' src='/static/07dfc7a7fbbdf936a0f78809274688e7/ca1dc/next-auth.png' srcset='/static/07dfc7a7fbbdf936a0f78809274688e7/e7570/next-auth.png 170w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/f46e7/next-auth.png 340w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/ca1dc/next-auth.png 680w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/02d09/next-auth.png 1020w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/9d567/next-auth.png 1360w,\n/static/07dfc7a7fbbdf936a0f78809274688e7/c7953/next-auth.png 1896w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>next-auth</figcaption>\n  </figure></p>\n<p>Next auth에 대해 공부하면서 기본적으로 password를 사용하지 않는 방향을 지향한다는 것을 알게 되었다. 비밀번호는 보통 하나의 비밀번호가 여러 곳에 사용되기 때문에 보안에 민감한 사항이라고 생각해, 기존 회원가입-로그인 로직 대신에 \"이메일 인증\"으로 교체하고, OAuth로 \"구글\"과 \"Github\"를 이용한 총 세가지 방식의 인증과정을 진행하기로 했다.</p>\n<p>OAuth를 이용할 때도 고려해야할 점은, 다른 플랫폼이지만 같은 email을 사용하는 경우이다. 고민을 해보았을 때 다른 플랫폼이지만 같은 email로 접속했을 때 같은 채용공고들을 보여줘도 괜찮을 것 같아 이부분은 provider 옵션에 <code class=\"language-text\">allowDangerousEmailAccountLinking</code>을 추가해서 처리했다.</p>\n<h3>사용 방법</h3>\n<p>Next-auth를 사용하기 위해서는 우선 <code class=\"language-text\">pages/api/auth/[...nextauth].ts</code>를 만들어야한다. 내가 사용한 <code class=\"language-text\">[...nextauth].ts</code>파일 내용은 아래와 같고, 코드의 이해를 돕기 위해서 공통 부분을 설명하고 각각의 provider들의 연결을 정리해보려 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> GoogleProvider <span class=\"token keyword\">from</span> <span class=\"token string\">\"next-auth/providers/google\"</span>\n<span class=\"token keyword\">import</span> GithubProvider <span class=\"token keyword\">from</span> <span class=\"token string\">\"next-auth/providers/github\"</span>\n<span class=\"token keyword\">import</span> EmailProvider <span class=\"token keyword\">from</span> <span class=\"token string\">\"next-auth/providers/email\"</span>\n<span class=\"token keyword\">import</span> NextAuth <span class=\"token keyword\">from</span> <span class=\"token string\">\"next-auth\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> PrismaAdapter <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@next-auth/prisma-adapter\"</span>\n<span class=\"token keyword\">import</span> prisma <span class=\"token keyword\">from</span> <span class=\"token string\">\"../../../prisma/prisma\"</span>\n<span class=\"token keyword\">import</span> nodemailer <span class=\"token keyword\">from</span> <span class=\"token string\">\"nodemailer\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> html<span class=\"token punctuation\">,</span> text <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../../../src/utils/emailFormat\"</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">NextAuth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  providers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token function\">GoogleProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      clientId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_ID</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      clientSecret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_SECRET</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      allowDangerousEmailAccountLinking<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">GithubProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      clientId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GITHUB_ID</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      clientSecret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GITHUB_SECRET</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      allowDangerousEmailAccountLinking<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">EmailProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      server<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EMAIL_SERVER</span><span class=\"token punctuation\">,</span>\n      from<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EMAIL_FROM</span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">async</span> <span class=\"token function\">sendVerificationRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        identifier<span class=\"token operator\">:</span> email<span class=\"token punctuation\">,</span>\n        url<span class=\"token punctuation\">,</span>\n        provider<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> server<span class=\"token punctuation\">,</span> from <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> host <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token constant\">URL</span></span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> transport <span class=\"token operator\">=</span> nodemailer<span class=\"token punctuation\">.</span><span class=\"token function\">createTransport</span><span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">await</span> transport<span class=\"token punctuation\">.</span><span class=\"token function\">sendMail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          to<span class=\"token operator\">:</span> email<span class=\"token punctuation\">,</span>\n          from<span class=\"token punctuation\">,</span>\n          subject<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Sign in to </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>host<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n          text<span class=\"token operator\">:</span> <span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url<span class=\"token punctuation\">,</span> host <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          html<span class=\"token operator\">:</span> <span class=\"token function\">html</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url<span class=\"token punctuation\">,</span> host<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n  session<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    strategy<span class=\"token operator\">:</span> <span class=\"token string\">\"jwt\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  adapter<span class=\"token operator\">:</span> <span class=\"token function\">PrismaAdapter</span><span class=\"token punctuation\">(</span>prisma<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  pages<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    signIn<span class=\"token operator\">:</span> <span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">JWT_SECRET</span><span class=\"token punctuation\">,</span>\n  debug<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  callbacks<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> session<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> user <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      session<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>id\n      <span class=\"token keyword\">return</span> session\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>공통 부분</h3>\n<ul>\n<li>secret: 배포 때, JWT를 만드는데 사용될 secret으로 터미널에 <code class=\"language-text\">openssl rand -base64 32</code> 을 입력해 만들어진 키를 env에 추가해 연결했다.</li>\n<li>debug: 연결된 provider의 토큰 내용이나 에러들을 볼 수 있는 옵션으로 터미널로 내용들을 확인할 수 있다.</li>\n<li>callbacks: 인증과정에서 필요한 내용들을 커스텀하는 부분으로 API에 필요한 id를 값을 기본적으로 <code class=\"language-text\">session/user</code>에 담겨있지 않아 추가해주었다.</li>\n<li>pages: custom 로그인 페이지를 연결할 url을 전달해 줄 수 있다.</li>\n<li>session: database와 연결하게 되면 사용자 정보가 세션으로 관리되기 때문에 jwt로 변경했다. database를 연결하지 않으면 기본적으로 jwt가 된다.</li>\n</ul>\n<p>callbacks에서 추가할 부분은 타입도 추가해줘야하기 때문에 <code class=\"language-text\">next-auth.d.ts</code>에서 정의해주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// types/next-auth.d.ts</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> DefaultUser <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"next-auth\"</span>\n<span class=\"token keyword\">declare</span> <span class=\"token keyword\">module</span> <span class=\"token string\">\"next-auth\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Session</span> <span class=\"token punctuation\">{</span>\n    user<span class=\"token operator\">:</span> DefaultUser <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span>\n      id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Adapter</h3>\n<p>사용자정보들을 저장할 DB를 연결하는 부분으로, next-auth는 다양한 DB를 지원한다. 그중에서 기존에 사용하던 firebase 대신에 prisma를 이용해 연결했다. Firebase를 사용하려했지만 현재 next-auth가 version 4로 업데이트 하면서 지원하지 않는 것을 확인했다.</p>\n<p>그래서 새로운 Database를 찾다가 <code class=\"language-text\">prisma</code>를 사용했다. <code class=\"language-text\">Prisma</code>는 ORM으로 SQL DB와 함께 사용되지만 현재 MongoDB까지 지원해줘, 데이터의 schema를 기입해서 안전하게 관리할 수 있고, 다양한 database를 지원하는 장점들로 선택했다.</p>\n<h4>Prisma를 이용한 DB 연결</h4>\n<p>prisma를 이용해 MongoDB를 연결하기 위해서 next-auth의 공식 홈페이지를 참고하면 되지만 주의할 부분이 있었다.</p>\n<p>공식 홈페이지의 schema의 VerificationToken 부분의 id가 없기 때문에 에러가 발생하는데, 이것을 해결하기 위해서는 다음과 같이 추가해 해결할 수 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// ...</span>\n\nmodel VerificationToken <span class=\"token punctuation\">{</span>\n  id         String   <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">id</span></span> @<span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span><span class=\"token function\">auto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">map</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_id\"</span><span class=\"token punctuation\">)</span> <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">db</span></span><span class=\"token punctuation\">.</span>ObjectId\n  identifier String\n  token      String   <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">unique</span></span>\n  expires    DateTime <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">map</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"expiresAt\"</span><span class=\"token punctuation\">)</span>\n\n  @<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">unique</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>identifier<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  @<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">map</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"verification_tokens\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>OAuth</h3>\n<p>OAuth로 사용한 Google과 Github에 연결하기 위해서는 각각 ID와 Secret을 전달해주어야한다. 이때 많이 에러가 났던 부분은 인증이 끝나고 돌아갈 <code class=\"language-text\">callback</code>을 설정해주는 부분이었다. 배포를 하면서 에러가 많이 난 부분이라 미리 로컬과 배포용 두개의 OAuth 인증 정보를 만들고, 각각 구분된 key와 secret으로 <code class=\"language-text\">.env.local</code>과 <code class=\"language-text\">.env.production</code>으로 해두었다면 헷갈리지 않았을텐데라는 아쉬움이 든다.</p>\n<h4>Google</h4>\n<p>Google의 경우는 GCP(Google Cloud Platform)에 들어가 사용자 인증정보- OAuth Client ID를 만들면 되는데 이때 주의할 점은 url주소를 잘 적어주어야했다.</p>\n<ul>\n<li>개발: url=<code class=\"language-text\">http://localhost:3000</code>, 승인된 리디렉션 URI= <code class=\"language-text\">http://localhost:3000/api/auth/callback/google</code></li>\n<li>배포: url= <code class=\"language-text\">http://moejob.shop</code>, 승인된 리디렉션 URI= <code class=\"language-text\">http://moejob.shop/api/auth/callback/google</code></li>\n</ul>\n<h4>Github</h4>\n<p>Github은 Github 본인계정의 settings-왼쪽 메뉴 가장하단의 developer settings-OAuth Apps를 이용해 추가하면 된다. 이때도 url주소를 주의해서 적어야했다. 특히 Github은 한번 인증된 계정의 url을 바꾸어도 잘 적용이 안되 새롭게 배포용 계정을 만들어서 인증했다.</p>\n<ul>\n<li>개발: Homepage URL=<code class=\"language-text\">http://localhost:3000</code>, Authorization callback URL= <code class=\"language-text\">http://localhost:3000/api/auth/callback/github</code></li>\n<li>배포: Homepage URL=<code class=\"language-text\">http://moejob.shop</code>, Authorization callback URL= <code class=\"language-text\">http://moejob.shop/api/auth/callback/github</code></li>\n</ul>\n<h3>Email</h3>\n<p>이메일을 연결하는 부분이 가장 힘들었던 부분중 하나다. Next-auth와 검색의 대부분은 <code class=\"language-text\">sendGrid</code>의 SMTP를 이용해 이메일을 보낼 수 있게 소개했지만, 가입을 해도 계정이 pending상태로 남아있어서 <code class=\"language-text\">Gmail</code>을 이용한 방법으로 바꾸었다.</p>\n<p>우선 next-auth자체에 <code class=\"language-text\">nodemailer</code>가 없기 때문에 nodemailer를 설치한 후에 연결해주었다. Gmail페이지에서 설정에 들어가 IMAP을 사용으로 수정하고, google계정의 앱비밀번호를 추가해 환경변수로 전달했다.</p>\n<ul>\n<li><code class=\"language-text\">EMAIL_SERVER =smtp://&lt;email>:&lt;app password>@smtp.gmail.com:587</code></li>\n<li><code class=\"language-text\">EMAIL_FROM=moejob@gmail.com</code></li>\n</ul>\n<p>이렇게 설정만 하면 기본 이메일 포맷으로 나오기 때문에 추가적인 포맷을 위해 EmailProvider option으로 sendVerificationRequest로 필요한 내용들을 전달 할 수 있다.</p>\n<h3>_app.tsx</h3>\n<p>각각의 Provider를 연결한 후에 컴포넌트에 적용하기 위해서는 next-auth가 제공하는 <code class=\"language-text\">SessionProvider</code>을 감싸주면 컴포넌트 내부에서 <code class=\"language-text\">useSession</code> hook을 이용해 session정보를 전역 상태로 사용할 수 있다. 덕분에 기존에 CSR에서 사용하고 있던 AuthService를 이용해 user를 따로 관리하지 않아도 되었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">MyApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Component<span class=\"token punctuation\">,</span> pageProps <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> AppProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dbService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DBServiceImpl</span><span class=\"token punctuation\">(</span>firebaseApp<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">QueryClientProvider</span></span> <span class=\"token attr-name\">client</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>queryClient<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DBProvider</span></span> <span class=\"token attr-name\">dbService</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>dbService<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SessionProvider</span></span> <span class=\"token attr-name\">basePath</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXTAUTH_URL</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            ...\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">SessionProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DBProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">QueryClientProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Proteceted Route</h3>\n<p>getServerSideProps로 session을 받아와 로그인 된 사용자인지 먼저 체크해 주는 방식을 통해 현재 로그인된 유저인지 먼저 확인할 수 있었다. 먼저 서버에서 사용자정보를 이용해 리다이렉션 시키기 때문에 페이지를 랜더링을 하지 않고, 리다이렉션이 가능하게 되었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  session<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> InferGetServerSidePropsType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> getServerSideProps<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MainLayout</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">JobSection</span></span> <span class=\"token attr-name\">session</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>session<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">MainLayout</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getServerSideProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> NextPageContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      redirect<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        destination<span class=\"token operator\">:</span> <span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> session <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Custom Login</h3>\n<p>Next auth를 이용하게 되면 기본적으로 제공해 주는 login 페이지가 있지만 이미 만들어둔 페이지가 있었기 때문에 custom 페이지와 연결했다. custom 페이지에서 provider를 이용하기 위해서는 서버로 해당 provider정보를 전달해 주어야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Login</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  providers<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> InferGetServerSidePropsType<span class=\"token operator\">&lt;</span><span class=\"token keyword\">typeof</span> getServerSideProps<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SEO</span></span> <span class=\"token attr-name\">title</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>로그인<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AuthLayout</span></span> <span class=\"token attr-name\">providers</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>providers<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">;\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Login\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getServerSideProps</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> req <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> NextPageContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> req <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      redirect<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        destination<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      providers<span class=\"token operator\">:</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getProviders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>👓성능 비교</h2>\n<p>크롬의 개발자도구를 이용해 완료 (페이지를 모두 불러오는데 까지 걸리는 시간)를 기준으로 CSR을 이용해 인증을 했을때 시간과 SSR을 이용해 인증을 했을 때 시간을 비교해보았다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/b96f3b1e1fe044a9a962962ee31c7865/1235c/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 38.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABcSAAAXEgFnn9JSAAABl0lEQVR42kVRSY7cMAz0T5JBkFvOeWMu85r+xyBAkMtc2mnY1r55kenusSqU0EgEEBaLpWKR7i6Xyzfv86efvXgRInCIZ/QvIYSG/Xp///Lj9fX777e3r1cRPvdPTt+L/3zm1rzTUkHZmAcVaBKShkmQtq6FC5GMjyS0I6XNYaQiYRON0tDIvIlz43zj2pBIu0hdpgNCqjOmBOMCrA/cwEEZBxZseZpn1CO0gVSa8fCvJpVpdx8j0rKgy8cH/kj7Eda9EFHZOVJMJaW5bDmXfd85qDwejzIzZ2+co3Ez15Z1fWJU1m0r3Xk+2Jk7Q0yY56W52bbM9xmWsSUTjuNAOQticOBGXN8QG38GC8I5D2LOlnd0jzuhv15PYwyTIqSUGMcJNedGmJetidSjjYbWmrEFnsdWSjUxxWvgCZBzRkd0xzCMZ+Id1of1QRWsXx4daVtxnQagFBhdBU1z5r3H7XZrPMEmMrurWEesPIzTaazlcRdEFq2uDP+YwEvPO8Ezdr/fYdkNN4etNZ5GG8s8dip5Osasc/gLSN9KsVQZ4NAAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='성능비교' title='' src='/static/b96f3b1e1fe044a9a962962ee31c7865/ca1dc/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png' srcset='/static/b96f3b1e1fe044a9a962962ee31c7865/e7570/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png 170w,\n/static/b96f3b1e1fe044a9a962962ee31c7865/f46e7/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png 340w,\n/static/b96f3b1e1fe044a9a962962ee31c7865/ca1dc/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png 680w,\n/static/b96f3b1e1fe044a9a962962ee31c7865/02d09/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png 1020w,\n/static/b96f3b1e1fe044a9a962962ee31c7865/9d567/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png 1360w,\n/static/b96f3b1e1fe044a9a962962ee31c7865/1235c/%ED%8E%98%EC%9D%B4%EC%A7%80%EC%84%B1%EB%8A%A5%EC%B8%A1%EC%A0%95.png 1506w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>성능비교</figcaption>\n  </figure></p>\n<p>위 사진과 같이 CSR은 총 1.52s, SSR은 955ms로 SSR이 CSR에 비해 38%정도 로딩속도를 개선된것을 알 수 있었다.</p>\n<h2>마치며</h2>\n<p>이렇게 서버사이드 렌더링을 이용해서 인증을 적용하면서 전체적으로 컴포넌트들이 간단해졌고, <strong>빈페이지를 보여주지 않고 페이지 이동</strong>이 이루어져 성능 개선도 이루어진 점이 너무 좋았다. 이후에는 페이지마다 권한을 정하고 페이지 개선을 한 후에 SEO와 HTTPS를 적용하는 작업을 할 예정이다.</p>\n<br/>\n<p>[참조]</p>\n<ul>\n<li><a href=\"https://www.inflearn.com/course/%EB%AA%A8%EC%9D%98%ED%95%B4%ED%82%B9-xss-%EA%B3%B5%EA%B2%A9%EA%B8%B0%EB%B2%95?inst=29e33bf1\">모의해킹 실무자가 알려주는, XSS 공격 기법</a></li>\n<li><a href=\"https://doctorson0309.tistory.com/605\">CSRF를 1분 만에 해결하는 방법</a></li>\n</ul>","frontmatter":{"title":"모으잡-SSR을 이용한 인증,인가 도입","date":"December 17, 2022","tags":["사이드프로젝트","모으잡"],"series":"모으잡"},"fields":{"slug":"/2022-12-17-모으잡-인증인가/","readingTime":{"minutes":25.205}}},"seriesList":{"edges":[{"node":{"id":"fbb4533a-723e-5252-ac98-c880bd9e222f","fields":{"slug":"/2022-09-22-채용공고-정리사이트-기획/"},"frontmatter":{"title":"채용공고 정리 서비스 기획"}}},{"node":{"id":"efb31bb7-b230-5b3a-bf03-af7bc949639c","fields":{"slug":"/2022-10-15-모으잡-기획-구체화/"},"frontmatter":{"title":"모으잡-기획 구체화"}}},{"node":{"id":"9c730376-b192-5125-bffc-4eeda18b7d68","fields":{"slug":"/2022-10-16-파이썬을-이용한-크롤러제작/"},"frontmatter":{"title":"모으잡-파이썬을 이용한 웹크롤러 제작"}}},{"node":{"id":"ee625e14-0c1c-52cc-97b4-7507fff98c99","fields":{"slug":"/2022-10-17-flask-서버만들기/"},"frontmatter":{"title":"모으잡-flask이용해 SSR서버만들기"}}},{"node":{"id":"72b694be-e580-5664-a455-ea458cd8ff2b","fields":{"slug":"/2022-10-20-모으잡-cors-에러핸들링/"},"frontmatter":{"title":"모으잡-express cors 에러, 에러핸들링"}}},{"node":{"id":"10d9caf7-56a9-5377-a0bb-d16a96bc0bbf","fields":{"slug":"/2022-10-22-모으잡-express-서버-제작-시작-cheerio/"},"frontmatter":{"title":"모으잡-express 서버 제작 시작과 cheerio"}}},{"node":{"id":"0318dcb1-92cd-5b90-92f7-6ac08d34934f","fields":{"slug":"/2022-10-23-모으잡-puppeteer-크롤러제작-프론트페이지-구상/"},"frontmatter":{"title":"모으잡-puppeteer을 이용한 크롤러제작, 프론트페이지 구상"}}},{"node":{"id":"ee78ba91-55fe-52e4-b52e-3fd75064102b","fields":{"slug":"/2022-10-24-모으잡-프론트페이지-UI제작/"},"frontmatter":{"title":"모으잡-프론트페이지 UI제작"}}},{"node":{"id":"4d8fbbcf-f6bd-532c-9616-d545a976bdc8","fields":{"slug":"/2022-10-25-모으잡-UI-수정-크롤링-데이터-연결/"},"frontmatter":{"title":"모으잡-프론트페이지 UI수정, 크롤링한 데이터 받아오기"}}},{"node":{"id":"2ae6ec5c-3c76-51df-9c62-42377b522f58","fields":{"slug":"/2022-11-23-모으잡-Next-migration/"},"frontmatter":{"title":"모으잡-Next js로 migration, 디자인 수정"}}},{"node":{"id":"f98d7300-5ba4-5582-81c9-563366499628","fields":{"slug":"/2022-11-25-모으잡-회원가입로그인-로직/"},"frontmatter":{"title":"모으잡-firebase를 이용한 회원가입 로직 구현"}}},{"node":{"id":"da8d5d14-2fc0-53f4-8a30-1b558488aa2c","fields":{"slug":"/2022-11-29-모으잡 DB연결과-크롤링-기능-연결/"},"frontmatter":{"title":"모으잡-DB연결과 크롤링 기능 연결"}}},{"node":{"id":"ce15da4f-20cc-557c-a65e-d3a9fc40a2d5","fields":{"slug":"/2022-11-30-모으잡-배포/"},"frontmatter":{"title":"모으잡-vercel부터 aws까지 배포과정"}}},{"node":{"id":"bc74e94c-1d4a-5507-a390-a54e07d094e6","fields":{"slug":"/2022-12-17-모으잡-인증인가/"},"frontmatter":{"title":"모으잡-SSR을 이용한 인증,인가 도입"}}},{"node":{"id":"7dbb331a-341a-5763-acac-83425a2e9707","fields":{"slug":"/2022-12-23-모으잡-기획-디자인 수정/"},"frontmatter":{"title":"모으잡-기획, 디자인 수정"}}},{"node":{"id":"204104d7-e0cf-5dff-9c31-15b046d4e428","fields":{"slug":"/2022-12-25-모으잡-서버사이드-랜더링을-이용한-성능개선/"},"frontmatter":{"title":"모으잡-서버사이드 랜더링을 이용한 성능 개선"}}}]},"previous":{"fields":{"slug":"/2022-12-30-이벤트/"},"frontmatter":{"title":"이벤트"}},"next":{"fields":{"slug":"/2022-12-23-모으잡-기획-디자인 수정/"},"frontmatter":{"title":"모으잡-기획, 디자인 수정"}}},"pageContext":{"id":"bc74e94c-1d4a-5507-a390-a54e07d094e6","series":"모으잡","previousPostId":"5d40ad58-a897-564b-9a54-5c4a65ca9c0c","nextPostId":"7dbb331a-341a-5763-acac-83425a2e9707"}},"staticQueryHashes":[],"slicesMap":{}}