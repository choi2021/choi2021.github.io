{"componentChunkName":"component---src-templates-post-jsx","path":"/2025-01-19-useFunnel-분석/","result":{"data":{"site":{"siteMetadata":{"title":"Troy DevLog"}},"markdownRemark":{"id":"ae2f4760-8f15-5064-8fc2-40a0eeb1067e","excerpt":"useFunnel 라이브러리는 2023 토스 Slash의 퍼널: 쏟아지는 페이지 한 방에 관리하기 발표에서 복잡한 퍼널간 상태관리를 위한 라이브러리 useFunnel을 소개되었고, 토스 프론트엔드 액셀러레이터 과정의 2주차 주제였던 라는 주제를 진행하고 분석하는 글을 작성했다.  개인적으로 새롭게 정리하게 된 이유는 기존 패키지과 달리 다양한 장점을 가지…","html":"<p>useFunnel 라이브러리는 2023 토스 Slash의 <a href=\"https://www.youtube.com/watch?v=NwLWX2RNVcw&#x26;t=50s\">퍼널: 쏟아지는 페이지 한 방에 관리하기 발표</a>에서 복잡한 퍼널간 상태관리를 위한 라이브러리 useFunnel을 소개되었고, 토스 프론트엔드 액셀러레이터 과정의 2주차 주제였던 <code class=\"language-text\">퍼널간 상태 관리하기</code>라는 주제를 진행하고 <a href=\"https://choi2021.github.io/2024-09-17-useFunnel-%EB%B6%84%EC%84%9D%ED%95%B4%EB%B3%B4%EA%B8%B0/\">분석하는 글</a>을 작성했다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/9f2a7ba033dbec28c60d7439db78a7a7/29e0e/useFunnel-previous-cover.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 74.70588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACu0lEQVR42p1TW0gUYRSet16SoF56ybBeCykTA0HJ0IxEUCOEUlILgsxIfOpCL0ElXehBci0VL0GuudqFjKTISEzdRYnddpUsdJXcVfc+Mzu7s/t1zqy7mG0EHTjMmX9mvvOd830jYC2CigRJEuHz+eD3+7X0er1YXV3Vao/Ho6XT6YSiKPhbCNFoRCtmZswwGcdhsXyF1WqFzWbD1NQUjEajdm8203OTCcPDw1oTjmg0mgwwdmi3L2Bubj7xgM83fpAM4A/AeCHLMgKBAKUIUZQoRaiqikgkogFtvP4TMBQK0w5l+AlQDgYhUYP/iXWAIQQJiJOZSpKkiREXiRlzcs3TMEt+h89C60RKAProRVbw59ISFhYX4fUTEAGL/BGlvNaMwbg5B6/G4/WRQxTEt5AQZdnhwJfJSUyTmtNmC2YoZ602OEisANlFIqZulwvLKytwuV0sERRaU0CUiYxIdayJoKox2zS1d6Hy1gM0tPaj7rEBtc161D7qQ83dNmSn78PBtJ04fqwYlSfP4FR5pcY0HA5rOxdp9wzI5ARWjaO7dwAfRkbhoTH9NKK6xvzHvB1bU9OQkpmDLXmlSMkvx66CEkhiAGokGmNHI7MjfgfU90JP+fH9O0xbzAlrfJ/9hs3bU5FeWIH8I6XIPFyCotN1tEdFc4YoB7HeRAnAp4YBuN0eeKnbmN2BUfsyTE4f+kxWbEvPwu4DR9F85Tyqy0/gUFkVjaskNbvAVDka791HRXUNGm404lpLN3T9g+gc+oQXE2YUVF1EbkkVxj6PQG94ieKKc6S6nByQF8txqb4egiBgf1Y2LlxvRNnV2yi9fBNn7zxERk4RNqXtwY6sHOzNK0RGdq7m1aSA8ZHHxieg0+nwzGBA/5shdL16i7bng2gfeI0nPT3Qtbahub0DTboWdHR2IE5k45/yCwIFJDXBOH+EAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='작성했던 이전글' title='' src='/static/9f2a7ba033dbec28c60d7439db78a7a7/ca1dc/useFunnel-previous-cover.png' srcset='/static/9f2a7ba033dbec28c60d7439db78a7a7/e7570/useFunnel-previous-cover.png 170w,\n/static/9f2a7ba033dbec28c60d7439db78a7a7/f46e7/useFunnel-previous-cover.png 340w,\n/static/9f2a7ba033dbec28c60d7439db78a7a7/ca1dc/useFunnel-previous-cover.png 680w,\n/static/9f2a7ba033dbec28c60d7439db78a7a7/02d09/useFunnel-previous-cover.png 1020w,\n/static/9f2a7ba033dbec28c60d7439db78a7a7/9d567/useFunnel-previous-cover.png 1360w,\n/static/9f2a7ba033dbec28c60d7439db78a7a7/29e0e/useFunnel-previous-cover.png 2366w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>작성했던 이전글</figcaption>\n  </figure></p>\n<p>개인적으로 새롭게 정리하게 된 이유는 기존 패키지과 달리 다양한 장점을 가지고 있고, 훨씬 다양한 유즈케이스를 관리하기 위해 새롭게 만들어져 오픈소스로 공개되어 분석해보고 싶었고, 1월부터 굉장히 복잡한 퍼널을 관리가 필요한 제품을 담당하게 되면서 퍼널에 대한 이해도를 높일 필요가 있다고 느꼈다.</p>\n<p>그러면 새로운 useFunnel 패키지에 대해 알아보고 분석해보자.</p>\n<h2>새로운 useFunnel은 어떤 문제를 해결하기 위한걸까?</h2>\n<p>기존 패키지가 있지만 새롭게 만들게 된 이유는 무엇일까? 새로운 패키지를 만들어주신 선영님과 민우님께서 사내 블로그에 올려주신 글을 통해 알아보자.</p>\n<ul>\n<li><a href=\"https://toss.tech/article/use-funnel-1\">@use-funnel 개발기 #1: 왜 기존 라이브러리를 두고 새로 만들었나?</a></li>\n<li><a href=\"https://toss.tech/article/use-funnel-2\">@use-funnel 개발기 #2: 기존 라이브러리를 어떻게 뜯어 고칠 것인가?</a></li>\n</ul>\n<h3>먼저 기존 라이브러리의 문제점</h3>\n<p>당시 선영님께서 담당하게 되신 서비스인 주택 담보 대출 비교 서비스는 굉장히 복잡한 퍼널 관리가 필요했고, 기존 사용중인 두가지 퍼널 관리 방식을 통해 구현되어 있었다.</p>\n<p>첫번째는 기존 use-funnel 패키지로 직관적이고 익숙하지만 퍼널과정에서 수집하게 되는 데이터 관리를 별도로 해야하는 문제점이 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">FormState</span> <span class=\"token punctuation\">{</span>\n  purpose<span class=\"token operator\">:</span> Purpose<span class=\"token punctuation\">;</span>\n  address<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  income<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Funnel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>formState<span class=\"token punctuation\">,</span> setFormState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Partial<span class=\"token operator\">&lt;</span>FormState<span class=\"token operator\">>></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>Funnel<span class=\"token punctuation\">,</span> setStep<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useFunnel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>FunnelName<span class=\"token punctuation\">.</span>대출목적선택<span class=\"token punctuation\">,</span> FunnelName<span class=\"token punctuation\">.</span>담보물선택<span class=\"token punctuation\">,</span> FunnelName<span class=\"token punctuation\">.</span>연소득입력<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    initialStep<span class=\"token operator\">:</span> FunnelName<span class=\"token punctuation\">.</span>대출목적선택<span class=\"token punctuation\">,</span>\n    stepQueryKey<span class=\"token operator\">:</span> <span class=\"token string\">'mortgage-loan-funnel'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Funnel</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Funnel.Step</span></span> <span class=\"token attr-name\">name</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>FunnelName<span class=\"token punctuation\">.</span>대출목적선택<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        &lt;대출목적선택\n          onNext=</span><span class=\"token punctuation\">{</span>purpose <span class=\"token operator\">=></span>\n            <span class=\"token function\">setFormState</span><span class=\"token punctuation\">(</span>prev <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prev<span class=\"token punctuation\">,</span> purpose <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token plain-text\">}\n        />\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Funnel.Step</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Funnel.Step</span></span> <span class=\"token attr-name\">name</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>FunnelName<span class=\"token punctuation\">.</span>담보물선택<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        &lt;담보물선택\n          onNext=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setFormState</span><span class=\"token punctuation\">(</span>prev <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prev<span class=\"token punctuation\">,</span> address <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        />\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Funnel.Step</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Funnel.Step</span></span> <span class=\"token attr-name\">name</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>FunnelName<span class=\"token punctuation\">.</span>연소득입력<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        &lt;연소득입력\n          onNext=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>income<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setFormState</span><span class=\"token punctuation\">(</span>prev <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prev<span class=\"token punctuation\">,</span> income <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        />\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Funnel.Step</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Funnel</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>두번째로는 XState 상태관리 도구를 이용하는 방식으로 퍼널과 상태를 함께 관리하지만 복잡하면서도 상태관리와 렌더링하는 컴포넌트 코드가 분리되어 있는 문제점이 있었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">createFunnelMachine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token generic-function\"><span class=\"token function\">createMachine</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Partial<span class=\"token operator\">&lt;</span>Context<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> Event<span class=\"token punctuation\">,</span> StateType<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\t  id<span class=\"token operator\">:</span> <span class=\"token string\">\"mortgage-loan-funnel\"</span><span class=\"token punctuation\">,</span>\n\t\t  initial<span class=\"token operator\">:</span> <span class=\"token string\">\"대출목적선택\"</span><span class=\"token punctuation\">,</span>\n\t\t  states<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t대출목적선택<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tentry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> <span class=\"token function\">대출목적선택State검증</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\ton<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t대출목적선택완료<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n\t\t\t\t\t\t  <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t    target<span class=\"token operator\">:</span> <span class=\"token string\">\"담보물선택\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t    actions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t  <span class=\"token punctuation\">}</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">]</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\t\t담보물선택<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tentry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> <span class=\"token function\">담보물선택State검증</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\ton<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t담보물선택완료<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n\t\t\t\t\t\t  <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t    target<span class=\"token operator\">:</span> <span class=\"token string\">\"연소득입력\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t    actions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t  <span class=\"token punctuation\">}</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">]</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\t\t연소득입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tentry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> <span class=\"token function\">연소득입력State검증</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\ton<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t연소득입력완료<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n\t\t\t\t\t\t  <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t    target<span class=\"token operator\">:</span> <span class=\"token string\">\"입력완료\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t    actions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t  <span class=\"token punctuation\">}</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">]</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\t\t입력완료<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t  entry<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> <span class=\"token function\">입력완료State검증</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t  <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Funnel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>funnelMachine<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">createFunnelMachine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// useMachineRouter는 dispatch 시점에 적절한 다음 퍼널로 라우트시켜주는 기능을 구현한 hook이에요</span>\n  <span class=\"token comment\">// 내부적으로 XState의 useMachine을 사용해요</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>render<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMachineRouter</span><span class=\"token punctuation\">(</span>funnelMachine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function-variable function\">대출목적선택</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> dispatch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token operator\">&lt;</span>대출목적선택\n\t          onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>purpose <span class=\"token operator\">=></span>\n\t            <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"대출목적선택완료\"</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> purpose <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\t        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">담보물선택</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> dispatch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token operator\">&lt;</span>담보물선택\n\t          onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>address <span class=\"token operator\">=></span>\n\t            <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"담보물선택완료\"</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> address <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\t        />\n        ),\n        연소득입력: (</span><span class=\"token punctuation\">{</span> dispatch <span class=\"token punctuation\">}</span><span class=\"token plain-text\">) => (\n          &lt;연소득입력\n\t          onNext=</span><span class=\"token punctuation\">{</span>income <span class=\"token operator\">=></span>\n\t            <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"연소득입력완료\"</span><span class=\"token punctuation\">,</span> payload<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> income <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t          <span class=\"token punctuation\">}</span><span class=\"token plain-text\">}\n\t        />\n        ),\n        입력완료: (</span><span class=\"token punctuation\">{</span> context <span class=\"token punctuation\">}</span><span class=\"token plain-text\">) => (\n          &lt;입력완료 context=</span><span class=\"token punctuation\">{</span>context<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> />\n        )\n      })}\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>둘다 공통적으로 뒤로가기와 앞으로 가기를 할 때, 수집한 데이터를 관리하는데 어려움이 존재하게 된다. 예를 들어 A->B->C 에서 B로 돌아가게 되면 A에서 수집한 데이터 외의 B에서 이미 수집한 데이터가 존재하게 된다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/3f2415d74453e5f932acc388d7c2e6b5/f97d7/simple-funnel.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 57.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDElEQVR42o2SP2gTURzHM+gkLq46FFwUh4qIguAgkqVQ/4FTJe2QVOPg4uKm0KKipoNIl5LGNqbo4FB0SWwKrS1ZapKGu+RsbXJ3Xpu7vnf3/txd7k/Q8yW2itVB+PHg93gfft/f9/tCABCMTN/12167ZTsAEggJO4lhtpDFihiUtewZhBgQH9DvgH6DhsXaEMFWiWsM3B3viz17MZ2j1Na2MTXMZUkZWSmOrhQLksJaXSc6dqyljJ+Ju2/vGeI6NOyQ2/Iys0uhowOhI9cvRh5ua2izCU2Ax0ur4Vw2nM1OVHiqobq4KSvATUWCBz3ByDFSygLSZrD75n3h4KnY/hNDl26NIWSubchKXUlx1av5/JV8Ps0LDrK46hdhXWrP3A4e9QZPzpLyHFuhA79+VzjQG913fLD/ZgIjqyE3NVlNVvguPDfNCx62RVnlhYabHu7Cp0n5ww48M7t86Ez88Pk7fdGnzDwNYJ86Sa4WWVy8sbAwVe3ATdUAuumnY8HzC0HiHCnldmR3Jp+MMtn9w4mfsIPsFF9jY5ns5CqHVYMZoWrI+3vyr50vx8d2YeslLzDZ1+bnk6WKtCZKX1UAqfcqvmfn326HBx9jbDHYRfYEV2VWs5rkaqq4xX+uQyZ7aii43xOM7rrNci7/M2exm/On4scNSWeytwBErb05/8cPM6FODZ127v/8YT8AkSv8GspfG4EAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='뒤로가기 데이터 관리 문제' title='' src='/static/3f2415d74453e5f932acc388d7c2e6b5/ca1dc/simple-funnel.png' srcset='/static/3f2415d74453e5f932acc388d7c2e6b5/e7570/simple-funnel.png 170w,\n/static/3f2415d74453e5f932acc388d7c2e6b5/f46e7/simple-funnel.png 340w,\n/static/3f2415d74453e5f932acc388d7c2e6b5/ca1dc/simple-funnel.png 680w,\n/static/3f2415d74453e5f932acc388d7c2e6b5/02d09/simple-funnel.png 1020w,\n/static/3f2415d74453e5f932acc388d7c2e6b5/9d567/simple-funnel.png 1360w,\n/static/3f2415d74453e5f932acc388d7c2e6b5/f97d7/simple-funnel.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>뒤로가기 데이터 관리 문제</figcaption>\n  </figure></p>\n<p>이부분을 읽으면서 <code class=\"language-text\">이미 선택한 데이터를 다시 선택하지 않아도 되게 해줄 수 있기 위해 이미 선택한 정보는 뒤로가기시에도 보관하는 게 좋지 않을까</code> 생각이 들었지만 아래와 같은 상황이라면 달라진다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/bf57cef601088430276adf965dc9de21/f97d7/complicated-funnel.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 85.88235294117648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC8ElEQVR42p1TW0gUURgeXwqKeqinCHqKCuyCQUFE4IMSpL7VS1czNSN6CHoLQogumIYQgeaDVpRdpMxCWnTJRbMLeNl1V9f2Ojs7O2dmzjlzZmYv42Zu/8wuPYT0EHwPZw7nm/Od7/s/DmN9VahYV1QGUJ1PQgwAVrUSMINNrnQUDjlw1jYoMUxqAqjDFJKyICCs5VT9p8qWMPzoD1nTTMbShNjnkqISi4pxhMdiCU8swSOiUVMUlVBUxOGAMTXMfGNYIcDnipKicRQMixKilJopRNSk0usL1I2O1I6OPPUvZIiRSMqROMo9bSnc3FW4u1+fG1P1PJc2s+4J//aqa5sPXrrc2qczM5nCOqLds77z4+P14+NdU7NYkGO8lBCUbF9D4eHRlftH9OmPoJ+zskvPBifWlNdzO05X19+RJMwLMkP0kXeu2uWqcrn6/POWlpbBPGIuPW4o3NgGl+tet32zlbVefviyfl9j2c6zdRc7xKSMZMqIsZBSBoKhgcVwMKVoxLC9pBkW+Jz51GN+7icpCRPTJvcPTW6saNpQ0VTb3BEOJ8IRARMd+FktDYCFWsqPqZqlGiuq8QuYtttAfj40uelAy5bDV441tiNE4nyqGAFx8PcI2DQIXC+RQfa6vRfgzXXNHZAKcTKER0YkDJCd8Is0ghTKR2iSL+44st9Pgua1expqGtsQwhBYlqXfLIZPuN2AwR8REA+jRljOenu9cHvvSmclW/iuMovLZazXw9/Kdpzhth6HNzPNFEQV3O72+k95PCc9Yz1efwbrkF9KorbbnZWF9kOlqCg1eEHpHfA8eOLyfJ3X9bQokVRM7Jr1wZDUjIz0+AJADob4HxHR6j1XuFVeuLVbn3bZZJAO/LyVX84vw8AU+xAKRt3zoXsz3rapmW+8mGaZWFz0BqJs4kX+1dXcu1aaiEByXLEVSNYAimJ7oyga8DVcKgZz/IOBlxDBzIJW2MWgaUiO+0clS1WDT7tnDGqzeiX/D78B7GlOvglmY7QAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='복잡한 퍼널에서의 뒤로가기 데이터 관리 문제' title='' src='/static/bf57cef601088430276adf965dc9de21/ca1dc/complicated-funnel.png' srcset='/static/bf57cef601088430276adf965dc9de21/e7570/complicated-funnel.png 170w,\n/static/bf57cef601088430276adf965dc9de21/f46e7/complicated-funnel.png 340w,\n/static/bf57cef601088430276adf965dc9de21/ca1dc/complicated-funnel.png 680w,\n/static/bf57cef601088430276adf965dc9de21/02d09/complicated-funnel.png 1020w,\n/static/bf57cef601088430276adf965dc9de21/9d567/complicated-funnel.png 1360w,\n/static/bf57cef601088430276adf965dc9de21/f97d7/complicated-funnel.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>복잡한 퍼널에서의 뒤로가기 데이터 관리 문제</figcaption>\n  </figure></p>\n<p>위 사진처럼 A → B → C → B(뒤로가기) → A(뒤로가기) → D → E로 이동한다면 했을때 선택한적 없어야하는 B의 값을 D, E 퍼널에서 갖게 되면서 별도로 원하는 데이터를 정제하는 과정이 필요하게 된다.</p>\n<p>이렇게 퍼널이 복잡해질수록 각 스텝에서 보유해야하는 데이터를 한정시켜주는게 데이터의 흐름을 이해하는데 조금 더 직관적이고 좋을 것 같다는 생각이 들었고 문제상황을 공감할 수 있었다.</p>\n<h2>기존 useFunnel의 또다른 문제점</h2>\n<p>기존의 useFunnel 패키지의 또다른 문제점은 <code class=\"language-text\">Next와의 강한 결합</code>이었다. 다른 라우팅 라이브러리와 환경(React Router DOM, react native 환경) 에서는 각자 자체적으로 구현해야 한다는 점이 있었고,\n퍼널에서 수집한 데이터의 타입이 <code class=\"language-text\">자동적으로 추론이 되지 않기 때문에</code> A퍼널에서 필수적으로 받아야하는 데이터가 B 퍼널에서 여전히 optional로 추론되기도 해 타입을 좁히는 코드가 별도로 필요했다.</p>\n<p>이 두가지 문제점을 추가로 개선한 버전이 바로 <code class=\"language-text\">새로운 useFunnel</code> 패키지였다. 그러면 이제 실제 코드를 보면서 분석해보자.</p>\n<h2>코드 분석</h2>\n<p>use-funnel 패키지를 다운받아서 내부 구조를 보게 되면 아래와 같은 구조를 확인할 수 있다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 306px; '>\n      <a class='gatsby-resp-image-link' href='/static/15546159629f3a8f40fe26b7ebae68ee/bed10/use-funnel-structure.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 44.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVR42pWS227CMBBE+Y6GXIztGF9ywRUQKDQhqELq///PdG0i1D6leRjZllZnZ3a94qKF3HaQdoA0A5QbwcQeSWqwzuz/RLUZa5FvPFZZUYOrA1Q7QPsb7P4BphYCg3KHNK8IyBqw8h3m2KMZHmjHb3B7QLLWy4BRZgJyDyY7CH2NzpJ0IexP5AAUHkJ1KO0FaVFNhW6hu1+RC75DqTts7Ud0+EZxg55un46T6T0HnoCeNn2ErT6hzDme9e5OGmMj465o/BfdT7PQF1DQpjVFlmHj5gRD0AAIDRglKDY0I6qdd0jfJhQHJ7buI0S7S1SAuaangdevEcwBfwDbqwLAh0gibAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='use-funnel 패키지 구조' title='' src='/static/15546159629f3a8f40fe26b7ebae68ee/bed10/use-funnel-structure.png' srcset='/static/15546159629f3a8f40fe26b7ebae68ee/e7570/use-funnel-structure.png 170w,\n/static/15546159629f3a8f40fe26b7ebae68ee/bed10/use-funnel-structure.png 306w' sizes='(max-width: 306px) 100vw, 306px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>use-funnel 패키지 구조</figcaption>\n  </figure></p>\n<p>위와 같은 프로젝트 구조를 통해 core 폴더는 라이브러리, 프레임워크와 상관없이 동일하게 적용되는 핵심로직을 가지고 있고, 라우팅 라이브러리/프레임워크 폴더들은 각각의 사용방법에 맞게 구체적인 구현이 되어있을 것으로 예상할 수 있다.</p>\n<p>이렇게 공통 코어 로직과 구체적인 구현을 분리하는 구조를 통해 특정 라우팅 라이브러리/프레임워크와의 강결합을 끊고 라이브러리의 유연성을 가지게 되었다.</p>\n<p>그러면 이제 핵심적이고 중요한 코어 폴더의 코드를 살펴보자.</p>\n<h3>Core 패키지</h3>\n<p>코어 패키지는 모든 패키지에서 공통적으로 사용되는 핵심 로직이 구현되어 있는 패키지이다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 298px; '>\n      <a class='gatsby-resp-image-link' href='/static/49b59021bac63fb80103c407d8af973e/c9fe3/core-structure.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 82.3529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42p2UWW7CMBiEc4/gmGx4iR0IgrIvRai9/4mmY4eC+tBC+oBsEvg0y28n2bhFVc+R10tUZgeZTyFkg1E27COkR5bPkARgUXUo1AYTd4Lg91FmBwIt/+chyw6JkC3JhOo5/P7KFw3SVA8DCkuGR05GEqTKYobC7VCaNUrNVW8wku51pRE4RT5Z9cBx0aEksFBr1PaISXOKz0TmkNGKiPAnQEY1rhYPhVV7Qq1WMHYLx323+ICfXTCdX7m+M+c5UmH+hIb3PxTWeg3rj9ANbdeLPuyozr2c5wNISKXeYNwBmiqryfLxQ/kPYHEDtrTZUGWw2S0+o+2wH3MkUmEHKAylUJVxeyi7QRkUxlyGzeStFCqkzVItY4bBtjLbeGpCy4OBUaHfozYbuOkZLZsNa7Bq/eH52PxmObTcEGAJbzg6echtZF4+fvexkfdSVrDtGYp7ZffM8e12tgdcDt/Aqj32F4S/8Age4qraKy+M81NYKE4SVurtzXLZZxgUhpHRbDnj875hO8jyF0H3zApHAEElAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='core 폴더 구조' title='' src='/static/49b59021bac63fb80103c407d8af973e/c9fe3/core-structure.png' srcset='/static/49b59021bac63fb80103c407d8af973e/e7570/core-structure.png 170w,\n/static/49b59021bac63fb80103c407d8af973e/c9fe3/core-structure.png 298w' sizes='(max-width: 298px) 100vw, 298px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>core 폴더 구조</figcaption>\n  </figure></p>\n<p>코어 패키지의 index.ts 파일을 살펴보면 다음과 같은 코드를 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// index.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> AnyFunnelState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./core.js\"</span>\n<span class=\"token keyword\">export</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./stepBuilder.js\"</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> CreateFunnelStepType <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./typeUtil.js\"</span>\n<span class=\"token keyword\">export</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./useFunnel.js\"</span></code></pre></div>\n<p>stepBuilder 등 추가적인 기능들을 제공하고 있지만, 이중 개인적으로 중요하다고 생각하는 핵심 <code class=\"language-text\">useFunnel.tsx</code> 파일을 살펴보면서 필요한 타입, 유틸 함수들을 하나씩 분석해보려 한다.</p>\n<p>처음 코드를 봤을 때 굉장히 복잡한 타입 정의에 압도를 당하는 느낌이어서 부분 부분 따라가며 이해하는 것이 좋다고 생각이 들어 쪼개서 분석해보았다.</p>\n<h4>UseFunnelOptions</h4>\n<p><code class=\"language-text\">UseFunnelOptions</code> 타입은 퍼널의 옵션을 정의하는 타입이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// core.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelState<span class=\"token operator\">&lt;</span>TName <span class=\"token keyword\">extends</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TContext <span class=\"token operator\">=</span> <span class=\"token builtin\">never</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  step<span class=\"token operator\">:</span> TName\n  context<span class=\"token operator\">:</span> TContext\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">AnyContext</span> <span class=\"token operator\">=</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">AnyStepContextMap</span> <span class=\"token operator\">=</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> AnyContext<span class=\"token operator\">></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>key <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span>\n      key<span class=\"token punctuation\">,</span>\n      TStepContextMap<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// useFunnel.tsx</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UseFunnelOptions<span class=\"token operator\">&lt;</span>TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  initial<span class=\"token operator\">:</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span>\n  steps<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>TStepName <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> FunnelStepOption<span class=\"token operator\">&lt;</span>\n      TStepContextMap<span class=\"token punctuation\">[</span>TStepName<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>UseFunnelOptions 타입은 라우팅 패키지별로 사용할 <code class=\"language-text\">createUseFunnel</code> 함수에 전달할 옵션을 정의하는 타입이다. initial 옵션을 정의할 때 <code class=\"language-text\">FunnelStateByContextMap</code> 타입을 사용하고 있는데,\n사용처에서 정의한 context 구조를 통해 스텝별 퍼널의 상태를 타입으로 정의하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// core.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelState<span class=\"token operator\">&lt;</span>TName <span class=\"token keyword\">extends</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TContext <span class=\"token operator\">=</span> <span class=\"token builtin\">never</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  step<span class=\"token operator\">:</span> TName\n  context<span class=\"token operator\">:</span> TContext\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">funnelState</code>는 퍼널의 상태를 정의하는 타입이다. 퍼널의 상태는 퍼널의 스텝과 퍼널에서 사용할 데이터를 정의하는 context로 구성되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// core.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>key <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span>\n      key<span class=\"token punctuation\">,</span>\n      TStepContextMap<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><code class=\"language-text\">FunnelStateByContextMap</code> 타입은 스텝별 퍼널 상태를 정의하는 타입으로 키는 문자열로 좁혀져 있는데 퍼널의 퍼널의 스텝은 <code class=\"language-text\">브라우저 히스토리</code>와 관련이 깊다보니 key가 될 수 있는 <code class=\"language-text\">string | number | symbol</code> 타입에서 string으로 좁히도록 되어있지 않을까 생각해볼 수 있었다.</p>\n<p>실제로 사용하는 코드를 보면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">EmailInput</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">PasswordInput</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">OtherInput</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  password<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> funnel <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">{</span>\n  이메일입력<span class=\"token operator\">:</span> EmailInput\n  비밀번호입력<span class=\"token operator\">:</span> PasswordInput\n  그외정보입력<span class=\"token operator\">:</span> OtherInput\n<span class=\"token punctuation\">}</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token string\">\"my-funnel-app\"</span><span class=\"token punctuation\">,</span>\n  initial<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    step<span class=\"token operator\">:</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">,</span>\n    context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>그러면 위 예제에서 전달될 타입들을 살펴보면 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">TStepContextMap</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  이메일입력<span class=\"token operator\">:</span> EmailInput\n  비밀번호입력<span class=\"token operator\">:</span> PasswordInput\n  그외정보입력<span class=\"token operator\">:</span> OtherInput\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStateByContextMap</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  이메일입력<span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span><span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">,</span> EmailInput<span class=\"token operator\">></span>\n  비밀번호입력<span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span><span class=\"token string\">\"비밀번호입력\"</span><span class=\"token punctuation\">,</span> PasswordInput<span class=\"token operator\">></span>\n  그외정보입력<span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span><span class=\"token string\">\"그외정보입력\"</span><span class=\"token punctuation\">,</span> OtherInput<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">UseFunnelOptions</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  initial<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    step<span class=\"token operator\">:</span> <span class=\"token keyword\">keyof</span> TStepContextMap\n    context<span class=\"token operator\">:</span> TStepContextMap<span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n  steps<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>TStepName <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> FunnelStepOption<span class=\"token operator\">&lt;</span>\n      TStepContextMap<span class=\"token punctuation\">[</span>TStepName<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기본적인 옵션 외에 steps는 퍼널의 타입을 커스텀하게 정의할 수 있는 옵션으로 옵셔널한 옵션이다. 이때 step별로 조금 더 세부적인 타입이나 런타임 에러를 체크할 수 있는 옵션을 정의할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// stepBuilder.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStepGuardOption<span class=\"token operator\">&lt;</span>TContext<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">guard</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> data <span class=\"token keyword\">is</span> TContext\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStepParseOption<span class=\"token operator\">&lt;</span>TContext<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">parse</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> TContext\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStepOption<span class=\"token operator\">&lt;</span>TContext<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span>\n  <span class=\"token operator\">|</span> FunnelStepGuardOption<span class=\"token operator\">&lt;</span>TContext<span class=\"token operator\">></span>\n  <span class=\"token operator\">|</span> FunnelStepParseOption<span class=\"token operator\">&lt;</span>TContext<span class=\"token operator\">></span></code></pre></div>\n<p><code class=\"language-text\">FunnelStepGuardOption</code>은 전달 받은 데이터가 특정 타입인지 검증하는 옵션이고, <code class=\"language-text\">FunnelStepParseOption</code>은 전달 받은 데이터를 특정 타입으로 변환하는 옵션이다.</p>\n<p><code class=\"language-text\">FunnelStepOption</code>은 두 옵션을 합치는 union 타입으로 정의되어 있는데 steps 옵션으로 두가지 방식을 다 사용할 수 있게 제공하고 있다.</p>\n<p>그러면 실제 사용 예제를 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useFunnel <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@use-funnel/next\"</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">FormState</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  email<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  password<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  other<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">이메일입력_guard</span><span class=\"token punctuation\">(</span>data<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> data <span class=\"token keyword\">is</span> FormState <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">비밀번호입력_parse</span><span class=\"token punctuation\">(</span>data<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FormState <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span> email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>\n      data <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token string\">\"email\"</span> <span class=\"token keyword\">in</span> data <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token keyword\">typeof</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">\"email\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"string\"</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"비밀번호입력 데이터가 아닙니다.\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>data<span class=\"token punctuation\">,</span> email<span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>email <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">그외정보입력_parse</span><span class=\"token punctuation\">(</span>\n  data<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FormState <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span> email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> password<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> other<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> parseData <span class=\"token operator\">=</span> <span class=\"token function\">비밀번호입력_parse</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span> <span class=\"token keyword\">in</span> parseData <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> parseData<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"비밀번호가 없습니다\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>parseData<span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> parseData<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span> other<span class=\"token operator\">:</span> parseData<span class=\"token punctuation\">.</span>other <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyFunnelApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> funnel <span class=\"token operator\">=</span> <span class=\"token function\">useFunnel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">\"step-by-step\"</span><span class=\"token punctuation\">,</span>\n    initial<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      step<span class=\"token operator\">:</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">,</span>\n      context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    steps<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      이메일입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> guard<span class=\"token operator\">:</span> 이메일입력_guard <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      비밀번호입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> parse<span class=\"token operator\">:</span> 비밀번호입력_parse <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      그외정보입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> parse<span class=\"token operator\">:</span> 그외정보입력_parse <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  funnel<span class=\"token punctuation\">.</span>step <span class=\"token operator\">===</span> <span class=\"token string\">\"이메일입력\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> funnel<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>email <span class=\"token comment\">// \"string\" | \"undefined\"</span>\n  funnel<span class=\"token punctuation\">.</span>step <span class=\"token operator\">===</span> <span class=\"token string\">\"비밀번호입력\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> funnel<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>email <span class=\"token comment\">// \"string\"</span>\n\n  funnel<span class=\"token punctuation\">.</span>step <span class=\"token operator\">===</span> <span class=\"token string\">\"비밀번호입력\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> funnel<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>password <span class=\"token comment\">// \"string\" | \"undefined\"</span>\n  funnel<span class=\"token punctuation\">.</span>step <span class=\"token operator\">===</span> <span class=\"token string\">\"그외정보입력\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> funnel<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>password <span class=\"token comment\">// \"string\"</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드는 공식 문서의 예제를 이용한 것으로 steps에 실제 런타임 에러를 체크할 수 있는 옵션을 정의하고 타입이 안전하게 추론되는 것을 확인할 수 있다.</p>\n<h4>UseFunnelResults</h4>\n<p>타입적으로 가장 복잡한 UseFunnelResults는 <code class=\"language-text\">createUseFunnel</code> 함수의 반환 타입이다. 해당 타입을 이해하기 위해 위와 같이 구성하는 타입들을 하나하나씩 살펴보며 이해해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// core.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">AnyStepContextMap</span> <span class=\"token operator\">=</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> AnyContext<span class=\"token operator\">></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">RouteOption</span> <span class=\"token operator\">=</span> Partial<span class=\"token operator\">&lt;</span>Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">>></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelState<span class=\"token operator\">&lt;</span>TName <span class=\"token keyword\">extends</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> TContext <span class=\"token operator\">=</span> <span class=\"token builtin\">never</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  step<span class=\"token operator\">:</span> TName\n  context<span class=\"token operator\">:</span> TContext\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">AnyFunnelState</span> <span class=\"token operator\">=</span> FunnelState<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> AnyContext<span class=\"token operator\">></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">GetFunnelStateByName<span class=\"token operator\">&lt;</span>\n  TFunnelState <span class=\"token keyword\">extends</span> AnyFunnelState<span class=\"token punctuation\">,</span>\n  TName <span class=\"token keyword\">extends</span> TFunnelState<span class=\"token punctuation\">[</span><span class=\"token string\">\"step\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> Extract<span class=\"token operator\">&lt;</span>TFunnelState<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> step<span class=\"token operator\">:</span> TName <span class=\"token punctuation\">}</span><span class=\"token operator\">></span></code></pre></div>\n<p><code class=\"language-text\">AnyStepContextMap</code>은 퍼널의 스텝별 데이터를 정의하는 타입이고, <code class=\"language-text\">RouteOption</code>은 퍼널의 라우트 옵션을 정의하는 타입으로 key를 문자열로 가지는 객체이다.</p>\n<p><code class=\"language-text\">FunnelState</code> 타입은 퍼널의 상태를 정의하는 타입으로 퍼널의 상태는 퍼널의 스텝과 퍼널에서 사용할 데이터를 정의하는 context로 구성되어 있다.</p>\n<p><code class=\"language-text\">GetFunnelStateByName</code> 타입은 FunnelState 타입에서 특정 스텝의 이름을 이용해 특정 퍼널의 상태를 추출하는 타입이다.</p>\n<p>예로 퍼널의 상태가 다음과 같이 정의되어 있다고 가정해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">StepContextMap</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  이메일입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">}</span>\n  비밀번호입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    password<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기에 특정 스텝의 상태를 추출하면 다음과 같은 타입이 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">이메일입력State</span> <span class=\"token operator\">=</span> GetFunnelStateByName<span class=\"token operator\">&lt;</span>StepContextMap<span class=\"token punctuation\">,</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token operator\">></span>\n<span class=\"token comment\">// {</span>\n<span class=\"token comment\">//   step: '이메일입력';</span>\n<span class=\"token comment\">//   context: { email?: string; }</span>\n<span class=\"token comment\">// }</span></code></pre></div>\n<p>이제 다음으로 히스토리 관리 메소드들, 트랜지션 함수를 정의하는 타입들을 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// router.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouterTransitionOption</span> <span class=\"token punctuation\">{</span>\n  renderComponent<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    overlay<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">TransitionFnArguments<span class=\"token operator\">&lt;</span>\n  TName <span class=\"token keyword\">extends</span> PropertyKey<span class=\"token punctuation\">,</span>\n  TContext<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> Partial<span class=\"token operator\">&lt;</span>TContext<span class=\"token operator\">></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TContext</span>\n  <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span>\n      target<span class=\"token operator\">:</span> TName<span class=\"token punctuation\">,</span>\n      context<span class=\"token operator\">?</span><span class=\"token operator\">:</span> TContext<span class=\"token punctuation\">,</span>\n      option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> TRouteOption\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      target<span class=\"token operator\">:</span> TName<span class=\"token punctuation\">,</span>\n      context<span class=\"token operator\">:</span> TContext<span class=\"token punctuation\">,</span>\n      option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> TRouteOption\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p><code class=\"language-text\">FunnelRouterTransitionOption</code> 타입은 퍼널의 라우트 옵션을 정의하는 타입으로 Overlay 형식의 컴포넌트도 퍼널의 스텝으로 관리하기 위해 정의되어 있다.</p>\n<p><code class=\"language-text\">TransitionFnArguments</code> 타입은 트랜지션 함수의 인자를 정의하는 타입으로 트랜지션 함수의 인자는 특정 스텝의 이름, 스텝의 데이터, 라우트 옵션으로 구성되어 있다.</p>\n<p>다음으로 step별로 required, optional 속성을 정의하는 util 타입을 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// typeUtils.ts</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">Prettify<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> Omit<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">never</span><span class=\"token operator\">></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">RequiredCompareKeys<span class=\"token operator\">&lt;</span>TBase<span class=\"token punctuation\">,</span> TResult<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span>\n  <span class=\"token operator\">|</span> <span class=\"token keyword\">keyof</span> TResult\n  <span class=\"token operator\">|</span> <span class=\"token keyword\">keyof</span> TBase <span class=\"token keyword\">extends</span> <span class=\"token class-name\"><span class=\"token keyword\">infer</span></span> <span class=\"token constant\">K</span>\n  <span class=\"token operator\">?</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TResult\n    <span class=\"token operator\">?</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TBase\n      <span class=\"token operator\">?</span> TBase<span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TResult</span><span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n        <span class=\"token operator\">?</span> <span class=\"token builtin\">never</span>\n        <span class=\"token operator\">:</span> <span class=\"token constant\">K</span>\n      <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TResult</span><span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">?</span> <span class=\"token builtin\">never</span>\n      <span class=\"token operator\">:</span> <span class=\"token constant\">K</span>\n    <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n  <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">OptionalCompareKeys<span class=\"token operator\">&lt;</span>TBase<span class=\"token punctuation\">,</span> TResult<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span>\n  <span class=\"token operator\">|</span> <span class=\"token keyword\">keyof</span> TBase\n  <span class=\"token operator\">|</span> <span class=\"token keyword\">keyof</span> TResult <span class=\"token keyword\">extends</span> <span class=\"token class-name\"><span class=\"token keyword\">infer</span></span> <span class=\"token constant\">K</span>\n  <span class=\"token operator\">?</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TResult\n    <span class=\"token operator\">?</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TBase\n      <span class=\"token operator\">?</span> TBase<span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TResult</span><span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n        <span class=\"token operator\">?</span> <span class=\"token constant\">K</span>\n        <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n      <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TResult</span><span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">?</span> <span class=\"token constant\">K</span>\n      <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n    <span class=\"token operator\">:</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TBase\n    <span class=\"token operator\">?</span> <span class=\"token constant\">K</span>\n    <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n  <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span></code></pre></div>\n<p><code class=\"language-text\">Prettify</code> 타입은 객체의 속성으로 never인 타입을 제외해 타입을 읽기 쉽게 만들어주는 타입이다.</p>\n<p><code class=\"language-text\">RequiredCompareKeys</code> 타입은 두가지 타입의 속성 중 <strong>필수 속성으로 변경/추가</strong>된 속성을 배열로 반환하고,<code class=\"language-text\">OptionalCompareKeys</code> 타입은 두가지 타입의 속성 중 <strong>선택 속성으로 변경된 속성과 공통으로 가지고 있는 속성</strong>을 배열로 반환한다.</p>\n<p>예시로 step별로 아래와 같은 타입이 있다고 가정해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">StepContextMap</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  이메일입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">}</span>\n  비밀번호입력<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    password<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러면 이제 두가지 타입의 속성을 합치면 RequiredCompareKeys와 OptionalCompareKeys 타입을 사용해 필수 속성과 선택 속성을 추출할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// 비밀번호입력 스텝에서:</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Required</span> <span class=\"token operator\">=</span> RequiredCompareKeys<span class=\"token operator\">&lt;</span>\n  StepContextMap<span class=\"token punctuation\">[</span><span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  StepContextMap<span class=\"token punctuation\">[</span><span class=\"token string\">\"비밀번호입력\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">></span> <span class=\"token comment\">// \"email\"</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Optional</span> <span class=\"token operator\">=</span> OptionalCompareKeys<span class=\"token operator\">&lt;</span>\n  StepContextMap<span class=\"token punctuation\">[</span><span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  StepContextMap<span class=\"token punctuation\">[</span><span class=\"token string\">\"비밀번호입력\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">></span> <span class=\"token comment\">// \"password\"</span></code></pre></div>\n<p>TransitionFn에서는 두가지 타입의 속성을 합치는 타입을 사용해 트랜지션 함수의 인자를 정의하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// typeUtils.ts</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">CompareMergeContext<span class=\"token operator\">&lt;</span>TBase<span class=\"token punctuation\">,</span> TResult<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> Prettify<span class=\"token operator\">&lt;</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token constant\">K</span> <span class=\"token keyword\">in</span> RequiredCompareKeys<span class=\"token operator\">&lt;</span>TBase<span class=\"token punctuation\">,</span> TResult<span class=\"token operator\">></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TResult\n      <span class=\"token operator\">?</span> TResult<span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">:</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TBase\n      <span class=\"token operator\">?</span> TBase<span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token constant\">K</span> <span class=\"token keyword\">in</span> OptionalCompareKeys<span class=\"token operator\">&lt;</span>TBase<span class=\"token punctuation\">,</span> TResult<span class=\"token operator\">></span><span class=\"token punctuation\">]</span><span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TBase\n      <span class=\"token operator\">?</span> TBase<span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">:</span> <span class=\"token constant\">K</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TResult\n      <span class=\"token operator\">?</span> TResult<span class=\"token punctuation\">[</span><span class=\"token constant\">K</span><span class=\"token punctuation\">]</span>\n      <span class=\"token operator\">:</span> <span class=\"token builtin\">never</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">></span>\n\n<span class=\"token comment\">//FunnelRender.tsx</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">TransitionFn<span class=\"token operator\">&lt;</span>\n  TState <span class=\"token keyword\">extends</span> AnyFunnelState<span class=\"token punctuation\">,</span>\n  TNextState <span class=\"token keyword\">extends</span> AnyFunnelState<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>TName <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TNextState</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"step\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">...</span>args<span class=\"token operator\">:</span>\n    <span class=\"token operator\">|</span> TransitionFnArguments<span class=\"token operator\">&lt;</span>\n        TName<span class=\"token punctuation\">,</span>\n        CompareMergeContext<span class=\"token operator\">&lt;</span>\n          TState<span class=\"token punctuation\">[</span><span class=\"token string\">\"context\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          GetFunnelStateByName<span class=\"token operator\">&lt;</span>TNextState<span class=\"token punctuation\">,</span> TName<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token string\">\"context\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n        TRouteOption\n      <span class=\"token operator\">></span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">[</span>\n        target<span class=\"token operator\">:</span> TName<span class=\"token punctuation\">,</span>\n        callback<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n          prev<span class=\"token operator\">:</span> TState<span class=\"token punctuation\">[</span><span class=\"token string\">\"context\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> GetFunnelStateByName<span class=\"token operator\">&lt;</span>TNextState<span class=\"token punctuation\">,</span> TName<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token string\">\"context\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> TRouteOption\n      <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>GetFunnelStateByName<span class=\"token operator\">&lt;</span>TNextState<span class=\"token punctuation\">,</span> TName<span class=\"token operator\">>></span></code></pre></div>\n<p><code class=\"language-text\">CompareMergeContext</code> 타입은 두가지 타입의 속성을 합치는 타입으로 필수 속성으로 변경된 값과 기존에 있거나 새롭게 추가된 선택 속성을 추출해 합치는 타입이다.</p>\n<p><code class=\"language-text\">TransitionFn</code> 타입은 트랜지션 함수를 정의하는 타입으로 인자는 두가지 인터페이스를 사용해 정의하고 있고 반환 타입은 특정 스텝의 상태를 Promise로 반환하는 타입이다. 제네릭을 보면 현재 <code class=\"language-text\">TState</code>와 <code class=\"language-text\">TNextState</code>는 트랜지션 함수의 현재 상태와 다음 상태를 정의하고 있고 <code class=\"language-text\">TRouteOption</code>는 트랜지션 함수의 라우트 옵션을 전달받는다.</p>\n<p>인자의 첫번째 방식은 <code class=\"language-text\">TransitionFnArguments</code> 타입을 사용해 특정 스텝의 이름, 스텝의 context, 라우트 옵션으로 구성된다.\nContext를 전달할 때 타입적으로 다음 스텝으로 퍼널 전환할 때 타입적으로 안전하게 context를 전달하게 하기 위해 <code class=\"language-text\">CompareMergeContext</code> 타입을 사용해 정의하고 있다. 비교대상은 <code class=\"language-text\">TState[context]</code> 타입와 <code class=\"language-text\">GetFunnelStateByName</code> 타입을 사용한 다음 스텝의 context로 정의된다.</p>\n<p>두번째 방식은 특정 스텝의 이름, 콜백 함수, 라우트 옵션으로 구성된다. 콜백 함수는 이전 스텝의 context를 받아 다음 스텝의 context를 반환하는 함수이다.</p>\n<p>이제 히스토리 타입을 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelTransition<span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TStepKey <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> TransitionFn<span class=\"token operator\">&lt;</span>\n  FunnelState<span class=\"token operator\">&lt;</span>TStepKey<span class=\"token punctuation\">,</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>NextStepKey <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span>\n      NextStepKey<span class=\"token punctuation\">,</span>\n      TStepContextMap<span class=\"token punctuation\">[</span>NextStepKey<span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  TRouteOption\n<span class=\"token operator\">></span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelHistory<span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TStepKey <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  push<span class=\"token operator\">:</span> FunnelTransition<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n  replace<span class=\"token operator\">:</span> FunnelTransition<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n  <span class=\"token function-variable function\">go</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>index<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span>\n  <span class=\"token function-variable function\">back</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">FunnelTransition</code> 타입은 퍼널의 전환 함수(트랜지션 함수)를 정의하는 타입으로 퍼널의 전환 함수는 퍼널의 상태, 다음 상태, 라우트 옵션으로 구성된다.</p>\n<p><code class=\"language-text\">FunnelHistory</code> 타입은 퍼널의 히스토리를 정의하는 타입으로 퍼널의 히스토리는 퍼널의 상태, 다음 상태, 라우트 옵션을 전달받아 트랜지션 함수를 정의하고 있다.\n우리가 자주보던 <code class=\"language-text\">window.history</code> API와 유사하게 <code class=\"language-text\">push</code>, <code class=\"language-text\">replace</code>, <code class=\"language-text\">go</code>, <code class=\"language-text\">back</code> 메소드를 정의하고 있다. 각 메소드는 FunnelTransition 타입을 통해 정의되어 있다.</p>\n<p>공식문서의 예시로 보면 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">declare</span> <span class=\"token keyword\">function</span> <span class=\"token function\">이메일입력</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">onNext</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element\n<span class=\"token keyword\">declare</span> <span class=\"token keyword\">function</span> <span class=\"token function\">비밀번호입력</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token function-variable function\">onNext</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>password<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element\n\n<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>funnel<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>이메일입력\n        onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>email <span class=\"token operator\">=></span> funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"비밀번호입력\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">case</span> <span class=\"token string\">\"비밀번호입력\"</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>비밀번호입력\n        email<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>funnel<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">}</span> <span class=\"token comment\">// optional -> required</span>\n        onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>password <span class=\"token operator\">=></span>\n          funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"그외정보입력\"</span><span class=\"token punctuation\">,</span> prev <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>prev<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이메일입력에서 onNext를 보게되면 email 데이터는 필수값으로 전달되고, 비밀번호 입력에서 context.email은 이메일입력에서 입력한 값이 있기 때문에 필수값으로 전달된다.</p>\n<p>다음으로 FunnelStep 타입을 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// FunnelRender.tsx</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStep<span class=\"token operator\">&lt;</span>\n  TStepContextMap<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 전체 스텝 컨텍스트 맵</span>\n  TStepKey<span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 현재 스텝 키</span>\n  TRouteOption     <span class=\"token comment\">// 라우팅 옵션</span>\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  step<span class=\"token operator\">:</span> TStepKey<span class=\"token punctuation\">;</span>                              <span class=\"token comment\">// 현재 스텝 이름</span>\n  context<span class=\"token operator\">:</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">// 현재 스텝의 컨텍스트</span>\n  history<span class=\"token operator\">:</span>FunnelHistory<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>         <span class=\"token comment\">// 히스토리 조작 메서드들</span>\n  index<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>                               <span class=\"token comment\">// 현재 스텝의 인덱스</span>\n  historySteps<span class=\"token operator\">:</span> FunnelState<span class=\"token operator\">&lt;</span><span class=\"token operator\">...</span><span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// 전체 히스토리 스텝들</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelStepByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span> TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">[</span>TStepKey <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> FunnelStep<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelRenderReady<span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token punctuation\">,</span>\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> FunnelStepByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">FunnelStep</code>은 앞서 정리해온 타입들을 이용해 퍼널 스텝을 정의하는 타입이다. 퍼널 스텝은 <code class=\"language-text\">step</code>, <code class=\"language-text\">context</code>, <code class=\"language-text\">history</code>, <code class=\"language-text\">index</code>, <code class=\"language-text\">historySteps</code>로 구성된다.</p>\n<p><code class=\"language-text\">FunnelStepByContextMap</code> 타입은 contextMap의 키값들을 키로, 값은 퍼널 스텝으로 가지는 객체에서 각 스텝별 FunnelStep 타입을 생성하는 유틸리티 타입을 반환하는 util 타입이다.</p>\n<p><code class=\"language-text\">FunnelRenderReady</code> 타입은 퍼널의 스텝을 정의하는 타입으로 퍼널의 스텝은 퍼널의 상태, 라우트 옵션을 전달받아 퍼널의 스텝을 정의하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// FunnelRender.tsx</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">FunnelRenderOverlayHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">close</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">RenderResult<span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TStepKey <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">\"render\"</span>\n      <span class=\"token function-variable function\">render</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n        step<span class=\"token operator\">:</span> FunnelStep<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> React<span class=\"token punctuation\">.</span>ReactNode\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">\"overlay\"</span>\n      <span class=\"token function-variable function\">render</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n        step<span class=\"token operator\">:</span> FunnelStep<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span> <span class=\"token operator\">&amp;</span>\n          FunnelRenderOverlayHandler\n      <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> React<span class=\"token punctuation\">.</span>ReactNode\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRenderComponentProps<span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  funnel<span class=\"token operator\">:</span> FunnelRenderReady<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n  steps<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>TStepKey <span class=\"token keyword\">in</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span>\n      <span class=\"token operator\">|</span> RenderResult<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n      <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>\n          step<span class=\"token operator\">:</span> FunnelStep<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> React<span class=\"token punctuation\">.</span>ReactNode<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">FunnelRenderOverlayHandler</code>는 overlay 형식의 컴포넌트를 렌더링할때 사용하는 타입으로 오버레이가 닫힐 때를 위해 close 메소드를 정의하고 있다.</p>\n<p><code class=\"language-text\">RenderResult</code> 타입은 퍼널 타입별로 렌더링함수의 타입을 정의하는 것으로 <code class=\"language-text\">render</code>, <code class=\"language-text\">overlay</code> 두가지 타입을 정의함으로서 이후에 퍼널 타입별로 렌더링함수를 정의할 때 타입적으로 안전하게 정의할 수 있다.</p>\n<p><code class=\"language-text\">FunnelRenderComponentProps</code> 타입은 RenderComponent의 prop을 정의하는 타입으로 퍼널의 렌더 컴포넌트는 퍼널의 스텝을 전달받아 렌더 함수를 정의하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// useFunnel.tsx</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">UseFunnelResults<span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Render<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>\n    props<span class=\"token operator\">:</span> FunnelRenderComponentProps<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token string\">\"steps\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">with</span><span class=\"token operator\">:</span> <span class=\"token keyword\">typeof</span> renderWith\n    overlay<span class=\"token operator\">:</span> <span class=\"token keyword\">typeof</span> overlayRenderWith\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token operator\">&amp;</span> FunnelStepByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span></code></pre></div>\n<p><code class=\"language-text\">UseFunnelResults</code> 타입은 앞서 소개한 타입들을 이용해 훅으로 반환되는 타입으로 <code class=\"language-text\">Render</code> 메소드는 <code class=\"language-text\">FunnelRenderComponentProps</code> 타입으로 prop을 전달받아 컴포넌트를 반환하고,\n<code class=\"language-text\">FunnelStepByContextMap</code> 타입으로 퍼널의 스텝을 반환하게 된다.</p>\n<p>실제 useFunnel훅을 사용하는 예제를 보면 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">declare</span> <span class=\"token keyword\">function</span> <span class=\"token function\">이메일입력</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">onNext</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element\n\n<span class=\"token keyword\">declare</span> <span class=\"token keyword\">function</span> <span class=\"token function\">비밀번호입력</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token function-variable function\">onNext</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>password<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element\n\n<span class=\"token keyword\">declare</span> <span class=\"token keyword\">function</span> <span class=\"token function\">그외정보입력</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSX</span><span class=\"token punctuation\">.</span>Element\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">SignupFunnel</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  이메일입력<span class=\"token operator\">:</span> 이메일입력\n  비밀번호입력<span class=\"token operator\">:</span> 비밀번호입력\n  그외정보입력<span class=\"token operator\">:</span> 그외정보입력\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// switch문을 사용한 구현</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyFunnelApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> funnel <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>SignupFunnel<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">\"my-funnel-app\"</span><span class=\"token punctuation\">,</span>\n    initial<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      step<span class=\"token operator\">:</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">,</span>\n      context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>funnel<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>이메일입력\n          onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>email <span class=\"token operator\">=></span> funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"비밀번호입력\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"비밀번호입력\"</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>비밀번호입력\n          email<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>funnel<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">}</span>\n          onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>password <span class=\"token operator\">=></span> funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"그외정보입력\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"그외정보입력\"</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>그외정보입력 <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Render 컴포넌트를 사용한 구현</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyFunnelApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> funnel <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>SignupFunnel<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">\"my-funnel-app\"</span><span class=\"token punctuation\">,</span>\n    initial<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      step<span class=\"token operator\">:</span> <span class=\"token string\">\"이메일입력\"</span><span class=\"token punctuation\">,</span>\n      context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>funnel<span class=\"token punctuation\">.</span>Render\n      이메일입력<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> history <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>이메일입력 onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>email <span class=\"token operator\">=></span> history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"비밀번호입력\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n      비밀번호입력<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> context<span class=\"token punctuation\">,</span> history <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>비밀번호입력\n          email<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>context<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">}</span>\n          onNext<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>password <span class=\"token operator\">=></span> history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"그외정보입력\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n      그외정보입력<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">&lt;</span>그외정보입력 <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>예제를 보면 퍼널 컴포넌트를 만들때 Switch문을 이용해서 각 스텝별로 컴포넌트를 렌더링할 수 있게 할 수 있고, <code class=\"language-text\">Render</code> 컴포넌트를 이용해서 각 스텝별로 컴포넌트를 렌더링할 수 있게 할 수 있다.</p>\n<p>그러면 이제 드디어 열심히 정리한 타입들을 이용해 이제 UseFunnel 타입을 만들 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">UseFunnel<span class=\"token operator\">&lt;</span>TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">&lt;</span>\n    _TStepContextMap <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AnyStepContextMap</span><span class=\"token punctuation\">,</span>\n    TStepKeys <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap <span class=\"token operator\">=</span> <span class=\"token keyword\">keyof</span> _TStepContextMap<span class=\"token punctuation\">,</span>\n    TStepContext <span class=\"token keyword\">extends</span> <span class=\"token class-name\">_TStepContextMap</span><span class=\"token punctuation\">[</span>TStepKeys<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _TStepContextMap<span class=\"token punctuation\">[</span>TStepKeys<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    TStepContextMap <span class=\"token keyword\">extends</span> <span class=\"token class-name\"><span class=\"token builtin\">string</span></span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap\n      <span class=\"token operator\">?</span> Record<span class=\"token operator\">&lt;</span>TStepKeys<span class=\"token punctuation\">,</span> TStepContext<span class=\"token operator\">></span>\n      <span class=\"token operator\">:</span> _TStepContextMap <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap\n      <span class=\"token operator\">?</span> Record<span class=\"token operator\">&lt;</span>TStepKeys<span class=\"token punctuation\">,</span> TStepContext<span class=\"token operator\">></span>\n      <span class=\"token operator\">:</span> _TStepContextMap\n  <span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n    options<span class=\"token operator\">:</span> UseFunnelOptions<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseFunnelResults<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>대부분의 타입에 대한 분석은 끝났으니 실 구현부를 보자.</p>\n<h4>FunnelRender</h4>\n<p>funnelRender는 Render컴포넌트에 해당되는 컴포넌트에 해당하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useUpdatableRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ref <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n  ref<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> value\n  <span class=\"token keyword\">return</span> ref\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useOverwriteFunnelHistoryTransitionArgument</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TStepKey <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  history<span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">callback</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n    step<span class=\"token operator\">:</span> TStepKey<span class=\"token punctuation\">,</span>\n    context<span class=\"token operator\">?</span><span class=\"token operator\">:</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> FunnelRouterTransitionOption\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> callbackRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>history<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> option<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n        <span class=\"token keyword\">const</span> newOption <span class=\"token operator\">=</span> callbackRef<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span>\n          step <span class=\"token keyword\">as</span> <span class=\"token builtin\">unknown</span> <span class=\"token keyword\">as</span> TStepKey<span class=\"token punctuation\">,</span>\n          context <span class=\"token keyword\">as</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          option\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>push <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> newOption<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> option<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n        <span class=\"token keyword\">const</span> newOption <span class=\"token operator\">=</span> callbackRef<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span>\n          step <span class=\"token keyword\">as</span> <span class=\"token builtin\">unknown</span> <span class=\"token keyword\">as</span> TStepKey<span class=\"token punctuation\">,</span>\n          context <span class=\"token keyword\">as</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          option\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>replace <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> newOption<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>history<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">FunnelRender</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> FunnelRenderComponentProps<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n  <span class=\"token keyword\">const</span> funnelRenderHistory <span class=\"token operator\">=</span> <span class=\"token function\">useOverwriteFunnelHistoryTransitionArgument</span><span class=\"token punctuation\">(</span>\n    funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> targetStep <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">const</span> isOverlay <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">typeof</span> targetStep <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">&amp;&amp;</span> targetStep<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"overlay\"</span>\n      <span class=\"token keyword\">const</span> newTransitionOption<span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>transitionOption<span class=\"token punctuation\">,</span>\n        renderComponent<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          overlay<span class=\"token operator\">:</span> isOverlay<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> newTransitionOption\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">useUpdatableRef</code> 훅은 컴포넌트가 리렌더링됨에 따라 최신 값을 유지하기 위해 사용되는 훅이다.</p>\n<p><code class=\"language-text\">useOverwriteFunnelHistoryTransitionArgument</code>는 overlay 타입의 스텝을 관리하기 위해 사용되는 훅으로 ovelay 타입인지 체크하고 새로운 트랜지션 옵션을 반환하는 훅이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> funnel<span class=\"token punctuation\">,</span> steps <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props\n<span class=\"token keyword\">const</span> render <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>funnel<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> renderEntires<span class=\"token operator\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">,</span> React<span class=\"token punctuation\">.</span>ReactNode<span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">const</span> funnelRenderHistory <span class=\"token operator\">=</span> <span class=\"token function\">useOverwriteFunnelHistoryTransitionArgument</span><span class=\"token punctuation\">(</span>\n  funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> targetStep <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> isOverlay <span class=\"token operator\">=</span>\n      <span class=\"token keyword\">typeof</span> targetStep <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">&amp;&amp;</span> targetStep<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"overlay\"</span>\n    <span class=\"token keyword\">const</span> newTransitionOption<span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>transitionOption<span class=\"token punctuation\">,</span>\n      renderComponent<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        overlay<span class=\"token operator\">:</span> isOverlay<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> newTransitionOption\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>props로 전달받은 steps를 통해 전체 퍼널 스텝 객체를 받고, 현재 스텝을 <code class=\"language-text\">funnel.step</code>으로 받아 현재 스텝에 해당하는 컴포넌트를 받는다.\n<code class=\"language-text\">funnelRenderHistory</code>는 overlay 타입인지 체크하고 새로운 트랜지션 옵션을 반환한다.</p>\n<p><code class=\"language-text\">renderEntires</code>는 현재 스텝과 현재 스텝의 컴포넌트를 배열로 저장하는 변수다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> funnelRenderStep <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>funnel<span class=\"token punctuation\">,</span>\n    history<span class=\"token operator\">:</span> funnelRenderHistory<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>funnel<span class=\"token punctuation\">,</span> funnelRenderHistory<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> render <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>funnelRenderStep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>render<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"render\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span> render<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>funnelRenderStep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>render<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"overlay\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> beforeSteps <span class=\"token operator\">=</span> funnelRenderStep<span class=\"token punctuation\">.</span>historySteps<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    funnelRenderStep<span class=\"token punctuation\">.</span>index\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> step <span class=\"token keyword\">of</span> beforeSteps<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> stepRender <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// NOTE: cannot use history in overlay render before steps</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> stepRender <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        <span class=\"token function\">stepRender</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n          <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n          history<span class=\"token operator\">:</span> overlayBeforeHistory<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        stepRender<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n          <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n          history<span class=\"token operator\">:</span> overlayBeforeHistory<span class=\"token punctuation\">,</span>\n          close<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stepRender<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"render\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  renderEntires <span class=\"token operator\">=</span> renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n    render<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n      close<span class=\"token operator\">:</span> funnelRenderHistory<span class=\"token punctuation\">.</span>back<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">funnelRenderStep</code>은 현재 스텝과 현재 스텝의 히스토리를 합쳐서 반환하는 객체다.\nrenderEntires에 현재 스텝과 현재 스텝의 컴포넌트를 배열로 저장하는데 이때 <code class=\"language-text\">render</code>의 타입에 따라 다르게 저장한다.</p>\n<ul>\n<li><code class=\"language-text\">((step: FunnelStep&lt;TStepContextMap, TStepKey, TRouteOption>) => React.ReactNode)</code>\n<code class=\"language-text\">render</code>의 타입이 함수일 경우로 render에 현재 스텝을 전달해 현재 스텝의 컴포넌트를 함께 저장한다.</li>\n<li><code class=\"language-text\">RenderResult</code>의 타입이 render인 경우\n<code class=\"language-text\">render.render(funnelRenderStep)</code>을 호출해 현재 스텝의 컴포넌트를 저장한다.</li>\n<li><code class=\"language-text\">RenderResult</code>의 타입이 overlay인 경우\noverlay인 경우에는 백그라운드에 이전 스텝의 컴포넌트가 함께 렌더링되어야 하기때문에 조금 복잡한 로직을 통해 이전 스텝의 컴포넌트를 함께 저장한다. 아래에서 조금 더 자세히 보자.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">neverUseHistory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">never</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot use history in overlay render before steps.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> overlayBeforeHistory<span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  push<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n  replace<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n  go<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n  back<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> beforeSteps <span class=\"token operator\">=</span> funnelRenderStep<span class=\"token punctuation\">.</span>historySteps<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>\n  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  funnelRenderStep<span class=\"token punctuation\">.</span>index\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> step <span class=\"token keyword\">of</span> beforeSteps<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> stepRender <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> stepRender <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">stepRender</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n        history<span class=\"token operator\">:</span> overlayBeforeHistory<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">break</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n      stepRender<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n        history<span class=\"token operator\">:</span> overlayBeforeHistory<span class=\"token punctuation\">,</span>\n        close<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stepRender<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"render\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">break</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nrenderEntires <span class=\"token operator\">=</span> renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nrenderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n  render<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n    close<span class=\"token operator\">:</span> funnelRenderHistory<span class=\"token punctuation\">.</span>back<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>type이 overlay인 경우 <code class=\"language-text\">overlayBeforeHistory</code>를 정의해 이전 스텝의 잘못된 history 변경을 방지한다. overlay가 직전 스텝인 경우에는 다시 이전 스텝이 필요하기 때문에,\nrender일때만 break한다. 마지막에 현재의 overlay스텝을 entries에 추가하고, overlay close 메소드를 통해 뒤로가기 메소드를 전달한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span>renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Fragment</span></span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>step<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>element<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>마지막으로 renderEntires를 이용해 정의된 요소들을 렌더링해 반환한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// 전체 코드</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">neverUseHistory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">never</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cannot use history in overlay render before steps.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> overlayBeforeHistory<span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  push<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n  replace<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n  go<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n  back<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">FunnelRender</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> FunnelRenderComponentProps<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> funnel<span class=\"token punctuation\">,</span> steps <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props\n  <span class=\"token keyword\">const</span> render <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>funnel<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">let</span> renderEntires<span class=\"token operator\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">,</span> React<span class=\"token punctuation\">.</span>ReactNode<span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n  <span class=\"token keyword\">const</span> funnelRenderHistory <span class=\"token operator\">=</span> <span class=\"token function\">useOverwriteFunnelHistoryTransitionArgument</span><span class=\"token punctuation\">(</span>\n    funnel<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> targetStep <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">const</span> isOverlay <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">typeof</span> targetStep <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">&amp;&amp;</span> targetStep<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"overlay\"</span>\n      <span class=\"token keyword\">const</span> newTransitionOption<span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>transitionOption<span class=\"token punctuation\">,</span>\n        renderComponent<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          overlay<span class=\"token operator\">:</span> isOverlay<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> newTransitionOption\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> funnelRenderStep <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>funnel<span class=\"token punctuation\">,</span>\n      history<span class=\"token operator\">:</span> funnelRenderHistory<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>funnel<span class=\"token punctuation\">,</span> funnelRenderHistory<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> render <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>funnelRenderStep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>render<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"render\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span> render<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>funnelRenderStep<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>render<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"overlay\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> beforeSteps <span class=\"token operator\">=</span> funnelRenderStep<span class=\"token punctuation\">.</span>historySteps<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>\n      <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      funnelRenderStep<span class=\"token punctuation\">.</span>index\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> step <span class=\"token keyword\">of</span> beforeSteps<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> stepRender <span class=\"token operator\">=</span> steps<span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">]</span>\n      <span class=\"token comment\">// NOTE: cannot use history in overlay render before steps</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> stepRender <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n          step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n          <span class=\"token function\">stepRender</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n            history<span class=\"token operator\">:</span> overlayBeforeHistory<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">break</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n          step<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n          stepRender<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n            history<span class=\"token operator\">:</span> overlayBeforeHistory<span class=\"token punctuation\">,</span>\n            close<span class=\"token operator\">:</span> neverUseHistory<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stepRender<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"render\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">break</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    renderEntires <span class=\"token operator\">=</span> renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n      funnelRenderStep<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n      render<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>funnelRenderStep<span class=\"token punctuation\">,</span>\n        close<span class=\"token operator\">:</span> funnelRenderHistory<span class=\"token punctuation\">.</span>back<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>renderEntires<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Fragment</span></span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>step<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>element<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Fragment</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useOverwriteFunnelHistoryTransitionArgument</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>\n  TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n  TStepKey <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption <span class=\"token keyword\">extends</span> RouteOption\n<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  history<span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">callback</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n    step<span class=\"token operator\">:</span> TStepKey<span class=\"token punctuation\">,</span>\n    context<span class=\"token operator\">?</span><span class=\"token operator\">:</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> FunnelRouterTransitionOption\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TStepKey<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> callbackRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>history<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> option<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n        <span class=\"token keyword\">const</span> newOption <span class=\"token operator\">=</span> callbackRef<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span>\n          step <span class=\"token keyword\">as</span> <span class=\"token builtin\">unknown</span> <span class=\"token keyword\">as</span> TStepKey<span class=\"token punctuation\">,</span>\n          context <span class=\"token keyword\">as</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          option\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>push <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> newOption<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> option<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n        <span class=\"token keyword\">const</span> newOption <span class=\"token operator\">=</span> callbackRef<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span>\n          step <span class=\"token keyword\">as</span> <span class=\"token builtin\">unknown</span> <span class=\"token keyword\">as</span> TStepKey<span class=\"token punctuation\">,</span>\n          context <span class=\"token keyword\">as</span> TStepContextMap<span class=\"token punctuation\">[</span>TStepKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n          option\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>replace <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> newOption<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>history<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>createUseFunnel</h4>\n<p>이제 코어 패키지의 찐 본채인 <code class=\"language-text\">createUseFunnel</code>을 분석해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouterOption<span class=\"token operator\">&lt;</span>TState <span class=\"token keyword\">extends</span> AnyFunnelState<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  initialState<span class=\"token operator\">:</span> TState<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouterTransitionOption</span> <span class=\"token punctuation\">{</span>\n  renderComponent<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    overlay<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouterResult<span class=\"token operator\">&lt;</span>TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  history<span class=\"token operator\">:</span> AnyFunnelState<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  currentIndex<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">push</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token operator\">:</span> AnyFunnelState<span class=\"token punctuation\">,</span> option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> TRouteOption<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">replace</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>state<span class=\"token operator\">:</span> AnyFunnelState<span class=\"token punctuation\">,</span> option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> TRouteOption<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">go</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>index<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">cleanup</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouter<span class=\"token operator\">&lt;</span>TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">(</span>option<span class=\"token operator\">:</span> FunnelRouterOption<span class=\"token operator\">&lt;</span>AnyFunnelState<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FunnelRouterResult<span class=\"token operator\">&lt;</span>TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">createUseFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  useFunnelRouter<span class=\"token operator\">:</span> FunnelRouter<span class=\"token operator\">&lt;</span>TRouteOption<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseFunnel<span class=\"token operator\">&lt;</span>TRouteOption<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p><code class=\"language-text\">useFunnelRouter</code>는 패키지별로 전달할 Router로 <code class=\"language-text\">FunnelRouterOption</code>을 전달받아 <code class=\"language-text\">FunnelRouterResult</code>를 반환하는 함수다.\n<strong>Core 패키지로 전달되는 Routing 패키지들의 인터페이스</strong>가 된다.</p>\n<p><code class=\"language-text\">FunnelRouterOption</code>에는 앞서 사용예시에서 전달하던 <code class=\"language-text\">id</code>와 <code class=\"language-text\">initialState</code>가 있고, <code class=\"language-text\">FunnelRouterResult</code>에는 <code class=\"language-text\">history</code>, <code class=\"language-text\">currentIndex</code>, <code class=\"language-text\">push</code>, <code class=\"language-text\">replace</code>, <code class=\"language-text\">go</code>, <code class=\"language-text\">cleanup</code> 있다.</p>\n<p><code class=\"language-text\">createUseFunnel</code>은 한마디로 말하면 라우팅 패키지들(<code class=\"language-text\">useFunnelRouter</code>)을 전달받아 현재 상태를 관리하고, <code class=\"language-text\">UseFunnelResult</code>를 반환하는 함수다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"> <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>\n    _TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n    TStepKeys <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap <span class=\"token operator\">=</span> <span class=\"token keyword\">keyof</span> _TStepContextMap<span class=\"token punctuation\">,</span>\n    TStepContext <span class=\"token keyword\">extends</span> _TStepContextMap<span class=\"token punctuation\">[</span>TStepKeys<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _TStepContextMap<span class=\"token punctuation\">[</span>TStepKeys<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    TStepContextMap <span class=\"token keyword\">extends</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap\n    <span class=\"token operator\">?</span> Record<span class=\"token operator\">&lt;</span>TStepKeys<span class=\"token punctuation\">,</span> TStepContext<span class=\"token operator\">></span>\n    <span class=\"token operator\">:</span> _TStepContextMap <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap <span class=\"token operator\">?</span> Record<span class=\"token operator\">&lt;</span>TStepKeys<span class=\"token punctuation\">,</span> TStepContext<span class=\"token operator\">></span> <span class=\"token operator\">:</span> _TStepContextMap<span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>options<span class=\"token operator\">:</span> UseFunnelOptions<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseFunnelResults<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> optionsRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">useFunnelRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      id<span class=\"token operator\">:</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n      initialState<span class=\"token operator\">:</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>initial<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> currentState <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">[</span>router<span class=\"token punctuation\">.</span>currentIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span>\n      options<span class=\"token punctuation\">.</span>initial<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> currentStateRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>currentState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">createUseFunnel</code>은 <code class=\"language-text\">useFunnel</code>함수를 반환하는데 이때 앞서 전달했던 타입들이 제네릭으로 정의되게 된다.</p>\n<p><code class=\"language-text\">optionsRef</code>는 최신 옵션값을 참조하게 되고, <code class=\"language-text\">router</code>에 해당 옵션을 전달해 라우팅 패키지들을 통해 퍼널 상태를 관리하게 된다.</p>\n<p><code class=\"language-text\">currentState</code>는 현재상태를, 비어있다면 옵션의 <code class=\"language-text\">initialState</code>를 참조하게 되고, <code class=\"language-text\">currentStateRef</code>는 이러한 현재 상태를 참조해 항상 최신 상태를 참조하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> cleanUpRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">.</span>cleanup<span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    cleanUpRef<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">cleanUpRef</code>는 패키지별로 정의된 <code class=\"language-text\">cleanup</code> 메소드를 가져와서 unmount시 실행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> parseStepContext <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TStep</span></span> <span class=\"token attr-name\">extends</span> <span class=\"token attr-name\">keyof</span> <span class=\"token attr-name\">TStepContextMap</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">(\n    step: TStep,\n    context: unknown\n  ): TStepContextMap[TStep] | null => </span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> stepOption <span class=\"token operator\">=</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>steps<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stepOption <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> context <span class=\"token keyword\">as</span> TStepContextMap<span class=\"token punctuation\">[</span>TStep<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 1. check parse function</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">funnelStepOptionIsParse</span><span class=\"token punctuation\">(</span>stepOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> stepOption<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 2. check guard function</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">funnelStepOptionIsGuard</span><span class=\"token punctuation\">(</span>stepOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> stepOption<span class=\"token punctuation\">.</span><span class=\"token function\">guard</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> context <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span><span class=\"token plain-text\">,\n  [optionsRef]\n)</span></code></pre></div>\n<p><code class=\"language-text\">parseStepContext</code>는 <code class=\"language-text\">steps</code> 옵션의 <code class=\"language-text\">guard</code>, <code class=\"language-text\">parse</code> 함수를 통해 현재 상태를 파싱하는 함수다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> history<span class=\"token operator\">:</span> FunnelHistory<span class=\"token operator\">&lt;</span>\n  TStepContextMap<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption\n<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> transition <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    step<span class=\"token operator\">:</span> <span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">,</span>\n    assignContext<span class=\"token operator\">?</span><span class=\"token operator\">:</span> object <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prev<span class=\"token operator\">:</span> object<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> object<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newContext <span class=\"token operator\">=</span>\n      <span class=\"token keyword\">typeof</span> assignContext <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span>\n        <span class=\"token operator\">?</span> <span class=\"token function\">assignContext</span><span class=\"token punctuation\">(</span>currentStateRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>currentStateRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>assignContext<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token function\">parseStepContext</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> newContext<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> context <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n      <span class=\"token operator\">?</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>initial\n      <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          step<span class=\"token punctuation\">,</span>\n          context<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">push</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n      <span class=\"token keyword\">const</span> nextState <span class=\"token operator\">=</span> <span class=\"token function\">transition</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> nextState <span class=\"token keyword\">as</span> <span class=\"token builtin\">never</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">replace</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n      <span class=\"token keyword\">const</span> nextState <span class=\"token operator\">=</span> <span class=\"token function\">transition</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> nextState <span class=\"token keyword\">as</span> <span class=\"token builtin\">never</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    go<span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>go<span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">back</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> router<span class=\"token punctuation\">.</span><span class=\"token function\">go</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>router<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">.</span>push<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">.</span>go<span class=\"token punctuation\">,</span> optionsRef<span class=\"token punctuation\">,</span> parseStepContext<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">history</code>는 현재 상태를 파싱하고, 현재 상태를 전달해 다음 상태를 만들어 라우팅 패키지별로 정의된 <code class=\"language-text\">transition</code> 메소드에 정의한다.</p>\n<p><code class=\"language-text\">currentStateRef</code>를 통해 최신 현재 상태를 참조하게 한 이유로 비동기로 호출되더라도 최신값을 조회할 수 있게 된다.</p>\n<p><code class=\"language-text\">transition</code> 메소드에서는 <code class=\"language-text\">parseStepContext</code>를 통해 현재 상태를 파싱하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> step<span class=\"token operator\">:</span> FunnelStep<span class=\"token operator\">&lt;</span>\n  TStepContextMap<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">keyof</span> TStepContextMap <span class=\"token operator\">&amp;</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  TRouteOption\n<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> validContext <span class=\"token operator\">=</span> <span class=\"token function\">parseStepContext</span><span class=\"token punctuation\">(</span>currentState<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span> currentState<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>validContext <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n      <span class=\"token operator\">?</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>initial\n      <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          step<span class=\"token operator\">:</span> currentState<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n          context<span class=\"token operator\">:</span> validContext<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    history<span class=\"token punctuation\">,</span>\n    index<span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>currentIndex<span class=\"token punctuation\">,</span>\n    historySteps<span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>history <span class=\"token keyword\">as</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n  currentState<span class=\"token punctuation\">,</span>\n  history<span class=\"token punctuation\">,</span>\n  router<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">,</span>\n  router<span class=\"token punctuation\">.</span>currentIndex<span class=\"token punctuation\">,</span>\n  parseStepContext<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">step</code>은 현재 상태에 대한 context가 유효한지 확인하고, 유효하다면 현재 상태를 전달해 <code class=\"language-text\">UseFunnelResult</code>의 <code class=\"language-text\">step</code>, <code class=\"language-text\">context</code>, <code class=\"language-text\">history</code>, <code class=\"language-text\">index</code>, <code class=\"language-text\">historySteps</code>를 전달하는 변수다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useStateSubscriberStore</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>state<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> stateRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> stateStoreRef <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Store<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    listeners<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>listeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>listeners<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> fn <span class=\"token operator\">!==</span> listeners<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">getSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> stateRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> listener <span class=\"token keyword\">of</span> stateStoreRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">listener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> stateStoreRef<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useStateStore</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>subscriberRef<span class=\"token operator\">:</span> MutableRefObject<span class=\"token operator\">&lt;</span>Store<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> subscriberRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">getSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> subscriberRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span>subscriberRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span><span class=\"token function\">getSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>subscriberRef<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> state<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">const</span> currentStepStoreRef <span class=\"token operator\">=</span> <span class=\"token function\">useStateSubscriberStore</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> Render <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> FunnelRenderComponentProps<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token string\">'steps'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> currentStep <span class=\"token operator\">=</span> <span class=\"token function\">useStateStore</span><span class=\"token punctuation\">(</span>currentStepStoreRef<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FunnelRender</span></span> <span class=\"token attr-name\">funnel</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>currentStep<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">steps</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">with</span><span class=\"token operator\">:</span> renderWith<span class=\"token punctuation\">,</span>\n        overlay<span class=\"token operator\">:</span> overlayRenderWith<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>currentStepStoreRef<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n    Render<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">useStateSubscriberStore</code>는 <code class=\"language-text\">useSyncExternalStore</code>와 동일하게 state를 참조하고, 변경될때마다 리스너를 호출하는 함수다.</p>\n<p><code class=\"language-text\">Render</code>는 현재 상태를 참조하고, 현재 상태를 전달해 <code class=\"language-text\">FunnelRender</code> 컴포넌트를 렌더링하는 함수다.\n이때 <code class=\"language-text\">Object.assign</code>을 통해 <code class=\"language-text\">FunnelRender</code> 컴포넌트에 <code class=\"language-text\">with</code>와 <code class=\"language-text\">overlay</code> 옵션을 할당하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// 전체 코드</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">createUseFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>TRouteOption <span class=\"token keyword\">extends</span> RouteOption<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  useFunnelRouter<span class=\"token operator\">:</span> FunnelRouter<span class=\"token operator\">&lt;</span>TRouteOption<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseFunnel<span class=\"token operator\">&lt;</span>TRouteOption<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>\n    _TStepContextMap <span class=\"token keyword\">extends</span> AnyStepContextMap<span class=\"token punctuation\">,</span>\n    TStepKeys <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap <span class=\"token operator\">=</span> <span class=\"token keyword\">keyof</span> _TStepContextMap<span class=\"token punctuation\">,</span>\n    TStepContext <span class=\"token keyword\">extends</span> _TStepContextMap<span class=\"token punctuation\">[</span>TStepKeys<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _TStepContextMap<span class=\"token punctuation\">[</span>TStepKeys<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    TStepContextMap <span class=\"token keyword\">extends</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap\n      <span class=\"token operator\">?</span> Record<span class=\"token operator\">&lt;</span>TStepKeys<span class=\"token punctuation\">,</span> TStepContext<span class=\"token operator\">></span>\n      <span class=\"token operator\">:</span> _TStepContextMap <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token keyword\">extends</span> <span class=\"token keyword\">keyof</span> _TStepContextMap\n      <span class=\"token operator\">?</span> Record<span class=\"token operator\">&lt;</span>TStepKeys<span class=\"token punctuation\">,</span> TStepContext<span class=\"token operator\">></span>\n      <span class=\"token operator\">:</span> _TStepContextMap\n  <span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n    options<span class=\"token operator\">:</span> UseFunnelOptions<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseFunnelResults<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token punctuation\">,</span> TRouteOption<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> optionsRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">useFunnelRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      id<span class=\"token operator\">:</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n      initialState<span class=\"token operator\">:</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>initial<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> currentState <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">[</span>router<span class=\"token punctuation\">.</span>currentIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span>\n      options<span class=\"token punctuation\">.</span>initial<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span>\n    <span class=\"token keyword\">const</span> currentStateRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>currentState<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> cleanUpRef <span class=\"token operator\">=</span> <span class=\"token function\">useUpdatableRef</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">.</span>cleanup<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        cleanUpRef<span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> parseStepContext <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TStep</span></span> <span class=\"token attr-name\">extends</span> <span class=\"token attr-name\">keyof</span> <span class=\"token attr-name\">TStepContextMap</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">(\n        step: TStep,\n        context: unknown\n      ): TStepContextMap[TStep] | null => </span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> stepOption <span class=\"token operator\">=</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>steps<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stepOption <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> context <span class=\"token keyword\">as</span> TStepContextMap<span class=\"token punctuation\">[</span>TStep<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 1. check parse function</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">funnelStepOptionIsParse</span><span class=\"token punctuation\">(</span>stepOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> stepOption<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 2. check guard function</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">funnelStepOptionIsGuard</span><span class=\"token punctuation\">(</span>stepOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> stepOption<span class=\"token punctuation\">.</span><span class=\"token function\">guard</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> context <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span><span class=\"token plain-text\">,\n      [optionsRef]\n    )\n\n    const history: FunnelHistory&lt;\n      TStepContextMap,\n      keyof TStepContextMap &amp; string,\n      TRouteOption\n    > = useMemo(() => </span><span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> transition <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n        step<span class=\"token operator\">:</span> <span class=\"token keyword\">keyof</span> TStepContextMap<span class=\"token punctuation\">,</span>\n        assignContext<span class=\"token operator\">?</span><span class=\"token operator\">:</span> object <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prev<span class=\"token operator\">:</span> object<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> object<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> newContext <span class=\"token operator\">=</span>\n          <span class=\"token keyword\">typeof</span> assignContext <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span>\n            <span class=\"token operator\">?</span> <span class=\"token function\">assignContext</span><span class=\"token punctuation\">(</span>currentStateRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token operator\">...</span>currentStateRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span>\n                <span class=\"token operator\">...</span>assignContext<span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> <span class=\"token function\">parseStepContext</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> newContext<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> context <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n          <span class=\"token operator\">?</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>initial\n          <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n              step<span class=\"token punctuation\">,</span>\n              context<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function-variable function\">push</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n          <span class=\"token keyword\">const</span> nextState <span class=\"token operator\">=</span> <span class=\"token function\">transition</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">return</span> nextState <span class=\"token keyword\">as</span> <span class=\"token builtin\">never</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">replace</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args\n          <span class=\"token keyword\">const</span> nextState <span class=\"token operator\">=</span> <span class=\"token function\">transition</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">,</span> assignContext<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">,</span> transitionOption<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">return</span> nextState <span class=\"token keyword\">as</span> <span class=\"token builtin\">never</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        go<span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>go<span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">back</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> router<span class=\"token punctuation\">.</span><span class=\"token function\">go</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token plain-text\">, [router.replace, router.push, router.go, optionsRef, parseStepContext])\n\n    const step: FunnelStep&lt;\n      TStepContextMap,\n      keyof TStepContextMap &amp; string,\n      TRouteOption\n    > = useMemo(() => </span><span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> validContext <span class=\"token operator\">=</span> <span class=\"token function\">parseStepContext</span><span class=\"token punctuation\">(</span>\n        currentState<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        currentState<span class=\"token punctuation\">.</span>context\n      <span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>validContext <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n          <span class=\"token operator\">?</span> optionsRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>initial\n          <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n              step<span class=\"token operator\">:</span> currentState<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n              context<span class=\"token operator\">:</span> validContext<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        history<span class=\"token punctuation\">,</span>\n        index<span class=\"token operator\">:</span> router<span class=\"token punctuation\">.</span>currentIndex<span class=\"token punctuation\">,</span>\n        historySteps<span class=\"token operator\">:</span>\n          router<span class=\"token punctuation\">.</span>history <span class=\"token keyword\">as</span> FunnelStateByContextMap<span class=\"token operator\">&lt;</span>TStepContextMap<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token plain-text\">, [\n      currentState,\n      history,\n      router.history,\n      router.currentIndex,\n      parseStepContext,\n    ])\n\n    const currentStepStoreRef = useStateSubscriberStore(step)\n\n    const Render = useMemo(() => </span><span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span>\n          props<span class=\"token operator\">:</span> FunnelRenderComponentProps<span class=\"token operator\">&lt;</span>\n            TStepContextMap<span class=\"token punctuation\">,</span>\n            TRouteOption\n          <span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token string\">\"steps\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> currentStep <span class=\"token operator\">=</span> <span class=\"token function\">useStateStore</span><span class=\"token punctuation\">(</span>currentStepStoreRef<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FunnelRender</span></span> <span class=\"token attr-name\">funnel</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>currentStep<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">steps</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">with</span><span class=\"token operator\">:</span> renderWith<span class=\"token punctuation\">,</span>\n          overlay<span class=\"token operator\">:</span> overlayRenderWith<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token plain-text\">, [currentStepStoreRef])\n\n    return </span><span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>step<span class=\"token punctuation\">,</span>\n      Render<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  }\n}</span></code></pre></div>\n<p>분석을 하면서 실 구현부 보다 타입정의가 복잡하게 느껴졌다. 코어 라이브러리의 핵심은 현재 스텝, 옵션의 최신 상태를 참조하고, 다음 상태를 만들어 라우팅 패키지별로 정의된 transition 메소드에 전달하는 것으로 정리할 수 있다.</p>\n<p>그러면 마지막으로 라우팅 패키지로 많이 사용하는 next 패키지를 분석해보려 한다.</p>\n<h3>next 패키지 분석하기</h3>\n<p>next는 현재 15버전 기준 <code class=\"language-text\">App router</code>를 지원한다. 분석하려는 패키지는 <code class=\"language-text\">Page router</code>를 기준으로 작성하려 하고, 공식문서를 보면 <code class=\"language-text\">App Router</code>는 <code class=\"language-text\">Browser</code> 패키지를 이용할 것을 권장하고 있다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/a122148f19a842734989a2a266c6a13f/98b00/install.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 62.35294117647059%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABRElEQVR42qVT2U7DMBDs/38TEgiB+oIQUjkqkGjF0ct27DQN8bnD2qmKKuAltbRZZ72azM44I/DqOgvnPNq2g6o0YkwYukb5sVisMHmYYnI/xePTM4ypyyERDQO8Ht/g7PwKF5dj3N5NIIQ6DTClhBBjyXncPL61Dh2HdTn3kni/r7NE5Yyjr4djwEobZiUhpYLWFTSPrJRmPQ0k5+VKlJqpt+V9w31CVtzf9+i9RD8MebTWEb48sHP9PtEJpjimPBMBb1XETMayb7qMSOVjGZwOQYf4FzCEiHUdIXcJm22C4NhZGs4wM7E+QjGgaBIDE+eIbWvxaRKWJmKRs2ywYa3XfAsU6/4XywPDj8rjnUee88gv61BiLj0am7Wlom3nIruanT929hegdRnAF7BXweA6FmMyCA27h+ys7d3N2tlAg3+9bz7mq2aLvb14AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='설치하기의 app router 관련 안내' title='' src='/static/a122148f19a842734989a2a266c6a13f/ca1dc/install.png' srcset='/static/a122148f19a842734989a2a266c6a13f/e7570/install.png 170w,\n/static/a122148f19a842734989a2a266c6a13f/f46e7/install.png 340w,\n/static/a122148f19a842734989a2a266c6a13f/ca1dc/install.png 680w,\n/static/a122148f19a842734989a2a266c6a13f/02d09/install.png 1020w,\n/static/a122148f19a842734989a2a266c6a13f/98b00/install.png 1202w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>설치하기의 app router 관련 안내</figcaption>\n  </figure></p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">QS_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"funnel.\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">STEP_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\".step\"</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CONTEXT_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\".context\"</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">HISTORY_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\".histories\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">checkIsHistoryKey</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  key<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token constant\">QS_KEY</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HISTORY_KEY</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>먼저 상단의 변수들을 보면 퍼널의 QueryString으로 사용될 키들이 정의되어 있다.\n<code class=\"language-text\">checkIsHistoryKey</code>는 해당 키가 히스토리 키인지 확인하는 함수다. 왜 별도로 히스토리 키를 체크하는 유틸함수가 있는지는 아래에서 설명하려 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TestPagesRouterFunnel</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> funnel <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>FunnelState<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token constant\">FUNNEL_ID</span><span class=\"token punctuation\">,</span>\n    initial<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> step<span class=\"token operator\">:</span> <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>funnel.Render</span>\n      <span class=\"token attr-name\">start</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> history <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">start</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middle\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> a<span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            next\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">middle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> history <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">middle</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> history<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> a<span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> b<span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            next\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">end</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">end</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">/></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 예제를 실행해보면 <code class=\"language-text\">http://localhost:3101?funnel.test.step=end&amp;funnel.test.context=%7B%22a%22%3A%221%22%2C%22b%22%3A%222%22%7D</code> 와 같은 형태로 생성되는 것을 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">NextPageRouteOption</span> <span class=\"token punctuation\">{</span>\n  shallow<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n  locale<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">false</span>\n  scroll<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> useFunnel <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">createUseFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> initialState <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p><code class=\"language-text\">NextPageRouteOption</code>은 <a href=\"https://nextjs.org/docs/pages/api-reference/functions/use-router#routerpush\">Next.js의 페이지 옵션 타입</a>으로 <code class=\"language-text\">shallow, locale, scroll</code> 옵션을 전달받는다.</p>\n<p>useFunnel은 앞서 코어 패키지를 분석하면서 보았던 <code class=\"language-text\">createUseFunnel</code>에 next page router에 맞춰 생성된 함수를 전달한다.\n<code class=\"language-text\">FunnelRouter&lt;TRouteOption></code> 타입으로 전달되는데 앞서 코어 패키지를 분석하면서 <code class=\"language-text\">FunnelRouterOption</code>을 파라미터로 <code class=\"language-text\">FunnelRouterResult</code>를 반환한다.</p>\n<p>전달된 타입을 작성해보면 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">NextPageRouteOption</span> <span class=\"token punctuation\">{</span>\n  shallow<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n  locale<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">false</span>\n  scroll<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouterResult<span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  history<span class=\"token operator\">:</span> AnyFunnelState<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  currentIndex<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span>\n  <span class=\"token function-variable function\">push</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n    state<span class=\"token operator\">:</span> AnyFunnelState<span class=\"token punctuation\">,</span>\n    option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> NextPageRouteOption\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span>\n  <span class=\"token function-variable function\">replace</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n    state<span class=\"token operator\">:</span> AnyFunnelState<span class=\"token punctuation\">,</span>\n    option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> FunnelRouterTransitionOption <span class=\"token operator\">&amp;</span> NextPageRouteOption\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span>\n  <span class=\"token function-variable function\">go</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>index<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span>\n  <span class=\"token function-variable function\">cleanup</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">FunnelRouter<span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">(</span>\n    option<span class=\"token operator\">:</span> FunnelRouterOption<span class=\"token operator\">&lt;</span>AnyFunnelState<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FunnelRouterResult<span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">createUseFunnel</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  useFunnelRouter<span class=\"token operator\">:</span> FunnelRouter<span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseFunnel<span class=\"token operator\">&lt;</span>NextPageRouteOption<span class=\"token operator\">></span></code></pre></div>\n<p>다른 라이브러리들에도 마찬가지로 RouterOption을 전달받을 것으로 예상할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">useRouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> currentContext <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> currentStep <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>query<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span>\n        <span class=\"token operator\">|</span> <span class=\"token builtin\">string</span>\n        <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">const</span> currentContext <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>query<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span>\n        <span class=\"token operator\">|</span> <span class=\"token builtin\">string</span>\n        <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span>\n      <span class=\"token keyword\">return</span> currentStep <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> currentContext <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n        <span class=\"token operator\">?</span> initialState\n        <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> step<span class=\"token operator\">:</span> currentStep<span class=\"token punctuation\">,</span> context<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>currentContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> initialState\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>router<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> _beforeHistories <span class=\"token operator\">=</span> router<span class=\"token punctuation\">.</span>query<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">HISTORY_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> beforeHistories <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useMemo</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> _beforeHistories <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n        <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        <span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>_beforeHistories <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>_beforeHistories<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> currentIndex <span class=\"token operator\">=</span> beforeHistories<span class=\"token punctuation\">.</span>length\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">router</code>는 Next.js의 useRouter 훅을 통해 현재 라우터 객체를 참조하게 된다.</p>\n<p><code class=\"language-text\">currentContext</code>는 앞서 정의한 queryString 키들을 통해 현재 상태를 참조하고, <code class=\"language-text\">beforeHistories</code>를 이용해 histories 상태들을 참조하게 된다.</p>\n<p><code class=\"language-text\">currentIndex</code>는 현재 스텝의 인덱스를 의미한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">return</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    history<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>beforeHistories<span class=\"token punctuation\">,</span> currentContext<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    currentIndex<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scroll<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">,</span> shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">makePath</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> queryContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>query<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">HISTORY_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n              <span class=\"token operator\">...</span>beforeHistories<span class=\"token punctuation\">,</span>\n              currentContext<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token function\">removeKeys</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>checkIsHistoryKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>queryContext <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          shallow<span class=\"token punctuation\">,</span>\n          locale<span class=\"token punctuation\">,</span>\n          scroll<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scroll<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">,</span> shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">makePath</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> queryContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>query<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token function\">removeKeys</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>checkIsHistoryKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>queryContext <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          shallow<span class=\"token punctuation\">,</span>\n          locale<span class=\"token punctuation\">,</span>\n          scroll<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">go</span><span class=\"token operator\">:</span> index <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">go</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">cleanup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">makePath</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> queryContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>query<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token function\">removeKeys</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>checkIsHistoryKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>queryContext <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          shallow<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">,</span> currentIndex<span class=\"token punctuation\">,</span> beforeHistories<span class=\"token punctuation\">,</span> currentContext<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>각 메소드를 보게되면 <code class=\"language-text\">FunnelRouterResult</code>의 메소드에 맞춰 작성되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">//utils.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> removeKeys <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>_value<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">any</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> conditions<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>_value <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> valueKeys <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  conditions<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>condition<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> condition <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">delete</span> value<span class=\"token punctuation\">[</span>condition<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      valueKeys<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">condition</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">delete</span> value<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> makePath <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>router<span class=\"token operator\">:</span> Pick<span class=\"token operator\">&lt;</span>NextRouter<span class=\"token punctuation\">,</span> <span class=\"token string\">'asPath'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'pathname'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'query'</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> asPath<span class=\"token punctuation\">,</span> query<span class=\"token operator\">:</span> _query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> router<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> query <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>_query <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> pathname <span class=\"token operator\">=</span> asPath<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> pathVariables <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>router<span class=\"token punctuation\">.</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">matchAll</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\[(.+?)\\]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>match<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> match<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 동적 라우트 변수를 추출</span>\n\n  pathVariables<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>variable<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">delete</span> query<span class=\"token punctuation\">[</span>variable<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">push</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scroll<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">,</span> shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">makePath</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> queryContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>query<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">HISTORY_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n              <span class=\"token operator\">...</span>beforeHistories<span class=\"token punctuation\">,</span>\n              currentContext<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token function\">removeKeys</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>checkIsHistoryKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>queryContext <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          shallow<span class=\"token punctuation\">,</span>\n          locale<span class=\"token punctuation\">,</span>\n          scroll<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scroll<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">,</span> shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">makePath</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> queryContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>query<span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          pathname<span class=\"token punctuation\">,</span>\n          query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span><span class=\"token function\">removeKeys</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>checkIsHistoryKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>queryContext <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          shallow<span class=\"token punctuation\">,</span>\n          locale<span class=\"token punctuation\">,</span>\n          scroll<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p><code class=\"language-text\">makePath</code>는 현재 라우터의 pathname과 query를 참조하고, <code class=\"language-text\">removeKeys</code>는 특정 조건에 따라 쿼리스트링에서 키를 제거하는 함수다.</p>\n<p><code class=\"language-text\">makePath</code>를 통해 query를 추출할때 동적 라우트 변수가 있는 경우 해당 변수를 제거해, 보다 명확하게 funnel 관련 query만 관리하기 위한 것으로 보였다.</p>\n<p><code class=\"language-text\">push, replace</code>를 보게되면 context를 <code class=\"language-text\">JSON.stringify</code>를 통해 문자열로 변환해 쿼리스트링에 전달하는 것을 확인할 수 있다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/5964851b0a8fead1d2736eedd6a3fa15/ce85c/push-interface.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 96.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAACN0lEQVR42q2U2ZKjMAxF+f9PTOUhOwkYHELYF7WOaFNhumteZlylSJaDdHUtORqGQfI8N3k+n/KvK3q/37Lf72W328nhcJCqqgRfXdfSNM1mjx18VaW+tpe6n1WP5h/HUSKM6/Uq3nspy9KQZllmexCj2RdFYfbr9bL/eJ9LUdaSv0fJy978fd9LxA+Hw9DL/1iRzLO0I7BVayYQd123ljfr+Z8yTZNM6LD/OIv4WXiYpVP4BEMCh7+v+YesATnuWohW/rxypbyBDk4ICl/whzjnlFcvzpeSvkWySiRXwe6GULKutBjkkHSyjxs5pbVegpPj8SiXy0XiODb7fD5rolqTt9K0SolS3gxLIOxx+ggIEv8s5H5/SKHIuE3QoB+Ph/rvkiTJ2gFpmkqm54hT27nE/FRmAfmQ1kEIgAYZgRACoPGFBAg238IiF7VyCD8c0ofhjwiBQjAQIgRFc/7bZFlAIpOJwKEkPkLjT60stxHKx09gvtsEZJH5dDopmtguIJTWNLWNFAOABPvTR7k/EHLTsR80q5Pb7WYBkyTdoA0crj6VtTPn+TOgIvSdnF0rt7yXpOh035t9zXo5Z4NkRS2PvJabJo3zzpK73Gvyq5VPArplLXkZ+OUhWNAlxlW4ZXz0JwItn7xtLgWogYtWG7bVxg3jt/haG0HT/WTN3Ggjt2qH8QxPl7UNhIKCqQAdI0d2WgIbWWz1VYONGlK1kzy/O4NzAq4IycQjyuv997V9DDYn34/DF6bxvEpIGkwQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='next router push interface' title='' src='/static/5964851b0a8fead1d2736eedd6a3fa15/ca1dc/push-interface.png' srcset='/static/5964851b0a8fead1d2736eedd6a3fa15/e7570/push-interface.png 170w,\n/static/5964851b0a8fead1d2736eedd6a3fa15/f46e7/push-interface.png 340w,\n/static/5964851b0a8fead1d2736eedd6a3fa15/ca1dc/push-interface.png 680w,\n/static/5964851b0a8fead1d2736eedd6a3fa15/02d09/push-interface.png 1020w,\n/static/5964851b0a8fead1d2736eedd6a3fa15/9d567/push-interface.png 1360w,\n/static/5964851b0a8fead1d2736eedd6a3fa15/ce85c/push-interface.png 1372w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>next router push interface</figcaption>\n  </figure></p>\n<p>이때 <code class=\"language-text\">push</code>와 <code class=\"language-text\">replace</code>의 두번째 파라미터에는 <code class=\"language-text\">as</code>로 실제 path와 다르게 보여질 수 있게 할 수 있다.\n예시로 가져왔던 <code class=\"language-text\">http://localhost:3101?funnel.test.step=end&amp;funnel.test.context=%7B%22a%22%3A%221%22%2C%22b%22%3A%222%22%7D</code>로 query상태를 조회하면 history가 감춰져 있는 것을 볼 수 있다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/72e5c555ecc2164134b50505a86f0be2/df264/query-state.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 15.294117647058824%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkklEQVR42nWOyw6CMBBF+f+PM67cGaMLRELLo4XSDvQwgIkrFyc9zZ2Z3GJoOkzV4FpHMD3BDnj1sfNMvSd2jkl9/LL7bHtmcxLVfW0xrzeh9RTiI5/Lnfr6wN6exLIi1oaki6IHpR0QF5B5QYIcLAfpZFI0W+NKTpliD11ptJm20nZZAyRD0lcHiPn8C7D8QX5sXCfoZtWNyVIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='query state' title='' src='/static/72e5c555ecc2164134b50505a86f0be2/ca1dc/query-state.png' srcset='/static/72e5c555ecc2164134b50505a86f0be2/e7570/query-state.png 170w,\n/static/72e5c555ecc2164134b50505a86f0be2/f46e7/query-state.png 340w,\n/static/72e5c555ecc2164134b50505a86f0be2/ca1dc/query-state.png 680w,\n/static/72e5c555ecc2164134b50505a86f0be2/02d09/query-state.png 1020w,\n/static/72e5c555ecc2164134b50505a86f0be2/9d567/query-state.png 1360w,\n/static/72e5c555ecc2164134b50505a86f0be2/df264/query-state.png 1878w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>query state</figcaption>\n  </figure></p>\n<p>removeKeys를 통해 history 키를 제거하는 것을 확인할 수 있다.</p>\n<p><code class=\"language-text\">push</code>는 현재 상태에 새로운 step과 context를 전달하고, <code class=\"language-text\">replace</code>는 현재 상태에 히스토리 변화없이 새로운 step과 context를 전달한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 브라우저 히스토리 이동</span>\n  <span class=\"token function-variable function\">go</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">go</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// 퍼널 상태 초기화</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">cleanup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 현재 경로 정보 가져오기</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pathname<span class=\"token punctuation\">,</span> query <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">makePath</span><span class=\"token punctuation\">(</span>router<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 퍼널 관련 쿼리 파라미터 제거</span>\n    <span class=\"token keyword\">const</span> queryContext <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">STEP_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">QS_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">CONTEXT_KEY</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 라우터 상태 업데이트</span>\n    <span class=\"token keyword\">await</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">{</span>\n        pathname<span class=\"token punctuation\">,</span>\n        query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token operator\">...</span>query<span class=\"token punctuation\">,</span>\n          <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        pathname<span class=\"token punctuation\">,</span>\n        query<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token operator\">...</span><span class=\"token function\">removeKeys</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>checkIsHistoryKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token operator\">...</span>queryContext<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        shallow<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">go</code>는 <code class=\"language-text\">window.history.go(index)</code>를 통해 히스토리를 이동하고, <code class=\"language-text\">cleanup</code>은 퍼널 관련 쿼리 파라미터를 제거하고 히스토리를 초기화한다. 코어 로직에서 봤듯이 해당 컴포넌트가 unmount될때 호출되는 것을 확인할 수 있다.</p>\n<p>이렇게 별도의 패키지로 분리해 두었기 때문에 이후에 다른 라우팅 라이브러리가 나오더라도 쉽게 구현할 수 있는 확장성을 가지고 있다.</p>\n<h3>정리</h3>\n<p><code class=\"language-text\">useFunnel</code>은 퍼널 상태를 관리하는 훅으로, 퍼널 상태를 초기화하고 히스토리를 이동하는 기능을 제공한다.\n구버전 <code class=\"language-text\">useFunnel</code>은 퍼널과 데이터를 따로 관리해야하는 점과 타입적으로 정확하게 추론하기 어려웠던 점이 있었고, next와 강한 결합으로 react-native, react-router-dom과 같은 라우터에서 사용할 수 없었다.</p>\n<p>이러한 문제점을 해결하기 위해 새로운 useFunnel이 등장하게 되었다. 보다 정확한 타입 추론과 여러가지 라우터를 지원할 수 있도록 개선되었고, 오버레이를 하나의 퍼널스텝으로도 사용할 수 있는 등 다양한 기능을 제공한다.</p>\n<p>내부 코드를 보면서 엄청난 타입 정의에 대해 놀랐다. 덕분에 타입스크립트도 함께 공부할 수 있었고, 앞으로 퍼널을 구현할 때 더 자신감을 가지고 사용할 수 있을 것 같다.</p>\n<p>위 예제는 next의 page router에 대한 구현만 작성했지만 이후에 React Native 환경, Next App router에 대해서 작업을 하면서 정리해가려 한다.</p>","frontmatter":{"title":"new useFunnel 분석해보기","date":"January 19, 2025","tags":["frontend","open-source","toss","react"],"series":null},"fields":{"slug":"/2025-01-19-useFunnel-분석/","readingTime":{"minutes":55.98}}},"seriesList":{"edges":[{"node":{"id":"4dd6f66b-f311-5b91-9eac-28095d67106f","fields":{"slug":"/2022-09-06-BEM과-자료형/"},"frontmatter":{"title":"BEM과 자바스크립트의 자료형"}}},{"node":{"id":"484c98ee-5762-55db-84b4-6b21ae960acf","fields":{"slug":"/2022-09-07-자바스트립트의-두가지-복사방법/"},"frontmatter":{"title":"자바스크립트의 두가지 복사 방법"}}},{"node":{"id":"352ba125-5786-518a-9c7a-303042a0755f","fields":{"slug":"/2022-09-07-자바스크립트의-타입과연산자/"},"frontmatter":{"title":"자바스크립트의 타입과 연산자"}}},{"node":{"id":"10db5919-95c0-53f5-94be-dcbac01e5d37","fields":{"slug":"/2022-09-10-intersection-observer /"},"frontmatter":{"title":"Intersection observer"}}},{"node":{"id":"5b188256-9365-5320-a67f-97afab6d630f","fields":{"slug":"/2022-09-12-브라우저API/"},"frontmatter":{"title":"Browser API"}}},{"node":{"id":"db56d225-cd7a-5168-8079-35d6d038e94f","fields":{"slug":"/2022-09-13-함수/"},"frontmatter":{"title":"함수"}}},{"node":{"id":"80cd5d8e-ad25-5b3f-921a-53a5f16a9bd5","fields":{"slug":"/2022-09-14-객체/"},"frontmatter":{"title":"객체"}}},{"node":{"id":"44dc8bd6-7888-58d2-b3fb-124760fd2e55","fields":{"slug":"/2022-09-17-빌트인객체/"},"frontmatter":{"title":"빌트인 객체"}}},{"node":{"id":"75d48151-20bb-5d55-9b13-7c77c923e577","fields":{"slug":"/2022-09-19-array/"},"frontmatter":{"title":"Array"}}},{"node":{"id":"962839d3-d3ea-5820-a045-07d3cdaa0079","fields":{"slug":"/2022-09-22-iteration/"},"frontmatter":{"title":"Iteration"}}},{"node":{"id":"cd30073c-7f4c-54d8-b893-090480da82c3","fields":{"slug":"/2022-09-24-Map과Set/"},"frontmatter":{"title":"Map과 Set"}}},{"node":{"id":"900f53ea-b7eb-5996-b44b-626400cf9d87","fields":{"slug":"/2022-10-06-HTTP란/"},"frontmatter":{"title":"HTTP 정리"}}},{"node":{"id":"458970f3-d49a-5b5f-8975-6f084e4ab43b","fields":{"slug":"/2022-10-18-Node-JS-기초/"},"frontmatter":{"title":"Node js:NodeJS 이용한 서버 만들기"}}},{"node":{"id":"f0792841-794b-5ec0-a351-a2f7605adc40","fields":{"slug":"/2022-10-19-Express-기초/"},"frontmatter":{"title":"NodeJS: express"}}},{"node":{"id":"d2bb44f2-60ad-5ed7-90ab-2bf43c831572","fields":{"slug":"/2022-11-18-CSR과-SSR/"},"frontmatter":{"title":"CSR과 SSR 그리고 Universal Rendering"}}},{"node":{"id":"cb62a84f-d1d5-5894-8175-64624d84a372","fields":{"slug":"/2022-11-20-스코프-실행컨테스트-클로저/"},"frontmatter":{"title":"스코프,실행컨텍스트,클로저"}}},{"node":{"id":"3b08f6c0-b947-5562-b38c-1228108dd551","fields":{"slug":"/2022-11-24-Critical-Rendering-Path/"},"frontmatter":{"title":"💻 Critical Rendering Path"}}},{"node":{"id":"9735256f-9deb-5bc5-a7a3-9d68d3278b4a","fields":{"slug":"/2022-11-27-비동기와-프로미스/"},"frontmatter":{"title":"비동기와 프로미스"}}},{"node":{"id":"ce607981-e768-5fdf-96d7-5d026072082f","fields":{"slug":"/2022-11-30-지스트-청원-서비스-회고/"},"frontmatter":{"title":"지스트 청원서비스 회고"}}},{"node":{"id":"f6194d07-b810-5332-9cbc-da0ce80eb312","fields":{"slug":"/2022-12-02-제너레이터와-async-await/"},"frontmatter":{"title":"제너레이터와 Async-Await"}}},{"node":{"id":"ad48afd5-0612-56fe-a974-7edb7de83a74","fields":{"slug":"/2022-12-03-모으잡-리팩토링/"},"frontmatter":{"title":"모으잡-check box 수정, react-query 커스텀 훅, 크롤링 이슈"}}},{"node":{"id":"2776079b-37ef-5268-9738-de277120a7da","fields":{"slug":"/2022-12-05-호이스팅/"},"frontmatter":{"title":"호이스팅"}}},{"node":{"id":"01501fd0-6b11-5e0d-80ae-5f607d766625","fields":{"slug":"/2022-12-09-쿠키-session-jwt/"},"frontmatter":{"title":"Cookie,Session과 JWT"}}},{"node":{"id":"72347779-5753-5035-b978-e4569b4f14cf","fields":{"slug":"/2022-12-09-this/"},"frontmatter":{"title":"this"}}},{"node":{"id":"a64e2757-3cf3-5eb6-a560-d93cbc6b68b2","fields":{"slug":"/2022-12-10-http와https/"},"frontmatter":{"title":"http와 https"}}},{"node":{"id":"89b94977-8c1a-5723-af2b-1bf7c7750ebe","fields":{"slug":"/2022-12-12-생성자함수-프로토타입/"},"frontmatter":{"title":"생성자 함수, 프로토타입"}}},{"node":{"id":"5d40ad58-a897-564b-9a54-5c4a65ca9c0c","fields":{"slug":"/2022-12-30-이벤트/"},"frontmatter":{"title":"이벤트"}}},{"node":{"id":"93b78365-058d-511b-bb11-72485e3f0d70","fields":{"slug":"/2022-12-23-class/"},"frontmatter":{"title":"클래스"}}},{"node":{"id":"94db5333-429d-592a-a409-e8f0a0c76354","fields":{"slug":"/2023-01-23-리액트의-기본원리/"},"frontmatter":{"title":"React study: 리액트의 기본 원리"}}},{"node":{"id":"fe5c6476-9c85-50cc-938a-137246b45864","fields":{"slug":"/2023-01-23-Vite와-번들러/"},"frontmatter":{"title":"Vite는 왜 빠를까, 번들러에 대한 정리"}}},{"node":{"id":"80445e0b-511b-5e28-bde0-99498fbf3a5d","fields":{"slug":"/2022-12-20-리액트-성능보장/"},"frontmatter":{"title":"React study: 리액트가 성능을 보장하는 방법"}}},{"node":{"id":"782ca102-9c01-52ee-8b4d-b5432da4b448","fields":{"slug":"/2023-02-03-useState,useEffect, useRef, memo/"},"frontmatter":{"title":"React Study: useState, useEffect, useRef, memo"}}},{"node":{"id":"c1d41785-332b-595b-b9b8-0c7a719657c7","fields":{"slug":"/2023-02-17-취업준비-회고/"},"frontmatter":{"title":"신입으로 시작하며 작성하는 취준 회고"}}},{"node":{"id":"e06ed826-880e-5b59-ae78-c098858b0634","fields":{"slug":"/2023-02-21-google.com-입력했을때-일어나는-일/"},"frontmatter":{"title":"google.com를 브라우저에 검색했을 때 일어나는 일"}}},{"node":{"id":"aad7179c-dbc9-5851-a7fd-38251e0a508b","fields":{"slug":"/2023-03-01-CDN/"},"frontmatter":{"title":"CDN은 뭘까?"}}},{"node":{"id":"beed37b9-064d-581e-89d3-b4c43838e429","fields":{"slug":"/2023-03-05-디자인패턴/"},"frontmatter":{"title":"MVC, MVVM, Flux패턴 그리고 Service와 Repository 패턴"}}},{"node":{"id":"6f3b633d-c73e-5585-b597-edaa1d26c2bb","fields":{"slug":"/2023-03-31-2023년-3월회고/"},"frontmatter":{"title":"🐤 2023년 3월 회고"}}},{"node":{"id":"aed1969e-b959-5454-8c2f-52c4a0ec6e94","fields":{"slug":"/2023-05-06-2023년-4월회고/"},"frontmatter":{"title":"😎 2023년 4월 회고"}}},{"node":{"id":"a73d6084-a910-5da1-bcb0-f555558f6e3b","fields":{"slug":"/2023-06-05-2023년-5월회고/"},"frontmatter":{"title":"☀︎ 2023년 5월 회고"}}},{"node":{"id":"90c8982f-2982-5a80-bd85-6283a0f82d70","fields":{"slug":"/2023-07-06-2023년-6월회고/"},"frontmatter":{"title":"☼ 2023년 6월 회고"}}},{"node":{"id":"88fffefc-5bb1-5a85-b1aa-b0ac1d4bed94","fields":{"slug":"/2023-08-09-2023년-7월회고/"},"frontmatter":{"title":"☂︎ 2023년 7월 회고"}}},{"node":{"id":"e274816c-0eb9-5b42-93d0-823495b63d87","fields":{"slug":"/2023-09-09-2023년-8월회고/"},"frontmatter":{"title":"😊 2023년 8월 회고"}}},{"node":{"id":"0370cc06-a8be-5505-9714-383d053b476d","fields":{"slug":"/2023-10-03-2023년-9월회고/"},"frontmatter":{"title":"🚅 2023년 9월 회고"}}},{"node":{"id":"4eea6c19-13d8-5363-bc87-963f217b7a42","fields":{"slug":"/2023-11-01-2023년-10월회고/"},"frontmatter":{"title":"🧐 2023년 10월 회고"}}},{"node":{"id":"a2a6e999-a53d-5e52-aae6-d57a75673c5f","fields":{"slug":"/2023-12-02-2023년-11월회고/"},"frontmatter":{"title":"😃 2023년 11월 회고"}}},{"node":{"id":"ee90f174-21d6-5bbf-b2cf-6fd226bc9353","fields":{"slug":"/2023-12-31-2023년-12월회고/"},"frontmatter":{"title":"🌟 2023년 12월 회고"}}},{"node":{"id":"642af668-e5c7-501d-bbaa-7a7e0724a982","fields":{"slug":"/2024-02-07-2024년-1월회고/"},"frontmatter":{"title":"🐥 2024년 1월회고"}}},{"node":{"id":"f30aaeb4-d2ed-5b78-82cb-556facbdb597","fields":{"slug":"/2024-03-02-2024년-2월회고/"},"frontmatter":{"title":"🙊 2024년 2월회고"}}},{"node":{"id":"0a55cde5-eb6e-50ef-a0b9-3307863119d1","fields":{"slug":"/2024-03-03-자바스크립트의-동시성-이해하기/"},"frontmatter":{"title":"Promise.all의 동시성 이해하기"}}},{"node":{"id":"b8f3cba2-e71c-5b78-9eef-169fcdfde70f","fields":{"slug":"/2024-03-30-App-StartUp-time-개선/"},"frontmatter":{"title":"App StartUp time 개선"}}},{"node":{"id":"8ffb09b1-c80e-58a2-b89a-6e3c6729e89b","fields":{"slug":"/2024-04-07-2024년-3월회고/"},"frontmatter":{"title":"🙌 2024년 3월회고"}}},{"node":{"id":"67fd6178-63b4-5b39-8e3c-fb1b0c5db869","fields":{"slug":"/2024-04-21-onViewableItemsChanged-이해해보기/"},"frontmatter":{"title":"👀 onViewableItemsChanged 이해해보기"}}},{"node":{"id":"40a3836b-74fe-59bb-80a8-7d921608f55a","fields":{"slug":"/2024-05-01-2024년-4월회고/"},"frontmatter":{"title":"🙌 2024년 4월회고"}}},{"node":{"id":"6a36dcc8-a80b-5581-9649-954e0ad0c5eb","fields":{"slug":"/2024-06-01-2024년-5월회고/"},"frontmatter":{"title":"🙌 2024년 5월회고"}}},{"node":{"id":"39b77a6b-96d6-5c2e-9012-c6b6be81f72d","fields":{"slug":"/2024-06-02-에러바운더리-도입하기/"},"frontmatter":{"title":"✅ 에러바운더리 도입하기"}}},{"node":{"id":"f85b5d27-6e2c-5dd3-8ca4-1f8b70fb4815","fields":{"slug":"/2024-06-30-2024년-6월회고/"},"frontmatter":{"title":"🤭 2024년 6월회고"}}},{"node":{"id":"e4ae5f2a-10c8-58d3-bacb-6a25ce1b95fc","fields":{"slug":"/2024-06-30-NativeStack적용하기/"},"frontmatter":{"title":"🖥️ Native Stack 적용하기"}}},{"node":{"id":"36c25ccf-f28b-5447-9899-c3d0d414a44f","fields":{"slug":"/2024-08-03-2024년-7월회고/"},"frontmatter":{"title":"👏 2024년 7월회고 "}}},{"node":{"id":"e7ef6c08-c8ff-556b-8f64-b2e61225fa6f","fields":{"slug":"/2024-09-15-2024년-8월회고/"},"frontmatter":{"title":"🥳 2024년 8월회고 "}}},{"node":{"id":"7e844836-6a81-5bd8-a59f-4907b5d6fab3","fields":{"slug":"/2024-09-17-useFunnel-분석해보기/"},"frontmatter":{"title":"📚 useFunnel 분석하고 따라 만들어 보기"}}},{"node":{"id":"54a91c29-22f4-5ec0-ac9b-2902d00e195d","fields":{"slug":"/2024-09-25-로딩경험-개선/"},"frontmatter":{"title":"⏳ 로딩 경험 개선"}}},{"node":{"id":"5d3a72d4-3907-5696-ba59-56b475ad67af","fields":{"slug":"/2024-10-01-2024년-9월-회고/"},"frontmatter":{"title":"9️⃣ 2024년 9월 회고"}}},{"node":{"id":"6ce7e536-b3fc-556d-84f8-09e393e3180e","fields":{"slug":"/2024-10-25-숨고를-떠나며/"},"frontmatter":{"title":"10월 회고, 숨고를 떠나며"}}},{"node":{"id":"f3912500-0fb7-5202-9f96-94405a29c7d7","fields":{"slug":"/2024-11-18-패키지매니저/"},"frontmatter":{"title":"패키지 매니저 비교해보기"}}},{"node":{"id":"f8303667-d369-58a3-bcc5-6d612982cfeb","fields":{"slug":"/2024-11-24-overlay-kit-분석/"},"frontmatter":{"title":"Overlay Kit 분석"}}},{"node":{"id":"e431d5fb-3f76-5190-b63a-51e32f5d7244","fields":{"slug":"/2024-12-01-2024년-11월회고/"},"frontmatter":{"title":"2024년 11월 회고, welcome to 토스"}}},{"node":{"id":"7e7c7b65-d941-5e27-bf28-d0d6785641d8","fields":{"slug":"/2024-12-27-2024년-12월회고/"},"frontmatter":{"title":"2024년 12월 회고, bye bye 2024"}}},{"node":{"id":"ae2f4760-8f15-5064-8fc2-40a0eeb1067e","fields":{"slug":"/2025-01-19-useFunnel-분석/"},"frontmatter":{"title":"new useFunnel 분석해보기"}}},{"node":{"id":"5f409a8e-dd1e-5c32-b6ba-f8ed6ad364ab","fields":{"slug":"/2025-01-27/"},"frontmatter":{"title":"2025년 1월 회고"}}}]},"previous":{"fields":{"slug":"/2024-12-27-2024년-12월회고/"},"frontmatter":{"title":"2024년 12월 회고, bye bye 2024"}},"next":{"fields":{"slug":"/2025-01-27/"},"frontmatter":{"title":"2025년 1월 회고"}}},"pageContext":{"id":"ae2f4760-8f15-5064-8fc2-40a0eeb1067e","series":null,"previousPostId":"7e7c7b65-d941-5e27-bf28-d0d6785641d8","nextPostId":"5f409a8e-dd1e-5c32-b6ba-f8ed6ad364ab"}},"staticQueryHashes":[],"slicesMap":{}}